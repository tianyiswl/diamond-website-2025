/**
 * ğŸ“ˆ é¡µé¢åŠ è½½æ€§èƒ½ä¼˜åŒ–å™¨
 * è§£å†³é¡µé¢åŠ è½½é—ªçƒé—®é¢˜ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
 * ä¼˜åŒ–CSSåŠ è½½ã€JavaScriptæ‰§è¡Œé¡ºåºå’Œç»„ä»¶æ¸²æŸ“
 */

(function() {
    'use strict';
    
    console.log('ğŸ“ˆ é¡µé¢åŠ è½½ä¼˜åŒ–å™¨å¼€å§‹æ‰§è¡Œ...');
    
    // é…ç½®é€‰é¡¹
    const CONFIG = {
        debug: false,                    // ç”Ÿäº§ç¯å¢ƒå…³é—­è°ƒè¯•
        loadingScreenSelector: '.loading-screen',
        headerSelector: '.header',
        footerSelector: '.footer',
        criticalCSSDelay: 50,           // å…³é”®CSSåº”ç”¨å»¶è¿Ÿ
        componentRenderDelay: 100,      // ç»„ä»¶æ¸²æŸ“å»¶è¿Ÿ
        loadingHideDelay: 300,          // åŠ è½½å±å¹•éšè—å»¶è¿Ÿ
        smoothTransitionDuration: 300   // å¹³æ»‘è¿‡æ¸¡æ—¶é—´
    };
    
    /**
     * é¡µé¢åŠ è½½ä¼˜åŒ–å™¨ç±»
     */
    class PageLoadOptimizer {
        constructor() {
            this.loadStartTime = performance.now();
            this.criticalResourcesLoaded = false;
            this.componentsRendered = false;
            this.loadingScreenHidden = false;
            this.metrics = {};
        }
        
        /**
         * è°ƒè¯•æ—¥å¿—
         */
        log(message, type = 'info') {
            if (!CONFIG.debug) return;
            
            const timestamp = performance.now() - this.loadStartTime;
            const prefix = `ğŸ“ˆ [${Math.round(timestamp)}ms] åŠ è½½ä¼˜åŒ–:`;
            
            switch(type) {
                case 'success':
                    console.log(`${prefix} âœ… ${message}`);
                    break;
                case 'error':
                    console.error(`${prefix} âŒ ${message}`);
                    break;
                case 'warn':
                    console.warn(`${prefix} âš ï¸ ${message}`);
                    break;
                default:
                    console.log(`${prefix} ${message}`);
            }
        }
        
        /**
         * åˆå§‹åŒ–ä¼˜åŒ–å™¨
         */
        init() {
            this.log('å¼€å§‹é¡µé¢åŠ è½½ä¼˜åŒ–...');
            
            // ç«‹å³åº”ç”¨å…³é”®æ ·å¼
            this.applyCriticalStyles();
            
            // ç¡®ä¿åŠ è½½å±å¹•æ˜¾ç¤º
            this.ensureLoadingScreen();
            
            // ç›‘å¬å…³é”®äº‹ä»¶
            this.setupEventListeners();
            
            // å¼€å§‹ä¼˜åŒ–æµç¨‹
            this.startOptimizationFlow();
        }
        
        /**
         * åº”ç”¨å…³é”®æ ·å¼é˜²æ­¢FOUC
         */
        applyCriticalStyles() {
            this.log('åº”ç”¨å…³é”®æ ·å¼é˜²æ­¢FOUC...');
            
            // åˆ›å»ºå…³é”®æ ·å¼
            const criticalCSS = `
                <style id="critical-styles">
                /* é˜²æ­¢FOUCçš„å…³é”®æ ·å¼ */
                .header { 
                    opacity: 0; 
                    transition: opacity ${CONFIG.smoothTransitionDuration}ms ease;
                }
                .header.loaded { 
                    opacity: 1; 
                }
                .footer { 
                    opacity: 0; 
                    transition: opacity ${CONFIG.smoothTransitionDuration}ms ease;
                }
                .footer.loaded { 
                    opacity: 1; 
                }
                .loading-screen { 
                    position: fixed !important; 
                    top: 0 !important; 
                    left: 0 !important; 
                    width: 100% !important; 
                    height: 100vh !important; 
                    background: linear-gradient(135deg, #002e5f 0%, #001a3a 100%) !important;
                    display: flex !important;
                    justify-content: center !important;
                    align-items: center !important;
                    z-index: 9999 !important;
                    transition: opacity ${CONFIG.smoothTransitionDuration}ms ease !important;
                }
                .loading-screen.hiding {
                    opacity: 0 !important;
                }
                .loading-screen.hidden {
                    display: none !important;
                }
                /* é˜²æ­¢å†…å®¹è·³åŠ¨ */
                body {
                    overflow-x: hidden;
                }
                .main-content {
                    min-height: 100vh;
                }
                </style>
            `;
            
            // æ’å…¥åˆ°headä¸­
            document.head.insertAdjacentHTML('beforeend', criticalCSS);
            
            this.log('å…³é”®æ ·å¼å·²åº”ç”¨', 'success');
        }
        
        /**
         * ç¡®ä¿åŠ è½½å±å¹•æ˜¾ç¤º
         */
        ensureLoadingScreen() {
            let loadingScreen = document.querySelector(CONFIG.loadingScreenSelector);
            
            if (!loadingScreen) {
                this.log('åˆ›å»ºåŠ è½½å±å¹•...');
                
                // åˆ›å»ºåŠ è½½å±å¹•
                loadingScreen = document.createElement('div');
                loadingScreen.className = 'loading-screen';
                loadingScreen.innerHTML = `
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">åŠ è½½ä¸­...</div>
                    </div>
                `;
                
                // æ’å…¥åˆ°bodyå¼€å¤´
                document.body.insertBefore(loadingScreen, document.body.firstChild);
                
                this.log('åŠ è½½å±å¹•å·²åˆ›å»º', 'success');
            } else {
                this.log('åŠ è½½å±å¹•å·²å­˜åœ¨');
            }
            
            // ç¡®ä¿åŠ è½½å±å¹•å¯è§
            loadingScreen.style.display = 'flex';
            loadingScreen.classList.remove('hiding', 'hidden');
        }
        
        /**
         * è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
         */
        setupEventListeners() {
            this.log('è®¾ç½®äº‹ä»¶ç›‘å¬å™¨...');
            
            // ç›‘å¬DOMå†…å®¹åŠ è½½å®Œæˆ
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    this.onDOMContentLoaded();
                });
            } else {
                setTimeout(() => this.onDOMContentLoaded(), 0);
            }
            
            // ç›‘å¬é¡µé¢å®Œå…¨åŠ è½½
            if (document.readyState !== 'complete') {
                window.addEventListener('load', () => {
                    this.onPageLoad();
                });
            } else {
                setTimeout(() => this.onPageLoad(), 0);
            }
            
            // ç›‘å¬ç»„ä»¶åŠ è½½äº‹ä»¶
            document.addEventListener('headerComponentLoaded', () => {
                this.onHeaderLoaded();
            });
            
            document.addEventListener('footerComponentLoaded', () => {
                this.onFooterLoaded();
            });
            
            // ç›‘å¬æ‰€æœ‰ç»„ä»¶åŠ è½½å®Œæˆ
            document.addEventListener('allComponentsLoaded', () => {
                this.onAllComponentsLoaded();
            });
        }
        
        /**
         * å¼€å§‹ä¼˜åŒ–æµç¨‹
         */
        startOptimizationFlow() {
            this.log('å¼€å§‹ä¼˜åŒ–æµç¨‹...');
            
            // é¢„åŠ è½½å…³é”®èµ„æº
            this.preloadCriticalResources();
            
            // ä¼˜åŒ–å›¾ç‰‡åŠ è½½
            this.optimizeImageLoading();
            
            // è®°å½•å¼€å§‹æ—¶é—´
            this.metrics.optimizationStartTime = performance.now();
        }
        
        /**
         * é¢„åŠ è½½å…³é”®èµ„æº
         */
        preloadCriticalResources() {
            this.log('é¢„åŠ è½½å…³é”®èµ„æº...');
            
            const criticalResources = [
                'assets/css/main.css',
                'assets/js/header-footer-components.js',
                'lightweight-search-fix.js'
            ];
            
            criticalResources.forEach(resource => {
                const link = document.createElement('link');
                link.rel = 'preload';
                link.as = resource.endsWith('.css') ? 'style' : 'script';
                link.href = resource;
                document.head.appendChild(link);
            });
            
            this.log('å…³é”®èµ„æºé¢„åŠ è½½å·²è®¾ç½®', 'success');
        }
        
        /**
         * ä¼˜åŒ–å›¾ç‰‡åŠ è½½
         */
        optimizeImageLoading() {
            this.log('ä¼˜åŒ–å›¾ç‰‡åŠ è½½...');
            
            // ä¸ºå›¾ç‰‡æ·»åŠ loading="lazy"
            const images = document.querySelectorAll('img:not([loading])');
            images.forEach(img => {
                img.loading = 'lazy';
            });
            
            this.log(`å·²ä¼˜åŒ– ${images.length} ä¸ªå›¾ç‰‡çš„åŠ è½½`, 'success');
        }
        
        /**
         * DOMå†…å®¹åŠ è½½å®Œæˆå¤„ç†
         */
        onDOMContentLoaded() {
            this.log('DOMå†…å®¹åŠ è½½å®Œæˆ');
            this.metrics.domContentLoadedTime = performance.now();
            
            // å¼€å§‹ç»„ä»¶æ¸²æŸ“ä¼˜åŒ–
            setTimeout(() => {
                this.optimizeComponentRendering();
            }, CONFIG.componentRenderDelay);
        }
        
        /**
         * é¡µé¢å®Œå…¨åŠ è½½å¤„ç†
         */
        onPageLoad() {
            this.log('é¡µé¢å®Œå…¨åŠ è½½');
            this.metrics.pageLoadTime = performance.now();
            
            // å¦‚æœç»„ä»¶è¿˜æ²¡æ¸²æŸ“å®Œæˆï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åå¼ºåˆ¶æ˜¾ç¤º
            setTimeout(() => {
                if (!this.componentsRendered) {
                    this.log('å¼ºåˆ¶æ˜¾ç¤ºé¡µé¢å†…å®¹', 'warn');
                    this.showPageContent();
                }
            }, 2000);
        }
        
        /**
         * é¡µå¤´åŠ è½½å®Œæˆå¤„ç†
         */
        onHeaderLoaded() {
            this.log('é¡µå¤´ç»„ä»¶åŠ è½½å®Œæˆ');
            this.metrics.headerLoadedTime = performance.now();
            
            // æ˜¾ç¤ºé¡µå¤´
            const header = document.querySelector(CONFIG.headerSelector);
            if (header) {
                header.classList.add('loaded');
            }
        }
        
        /**
         * é¡µè„šåŠ è½½å®Œæˆå¤„ç†
         */
        onFooterLoaded() {
            this.log('é¡µè„šç»„ä»¶åŠ è½½å®Œæˆ');
            this.metrics.footerLoadedTime = performance.now();
            
            // æ˜¾ç¤ºé¡µè„š
            const footer = document.querySelector(CONFIG.footerSelector);
            if (footer) {
                footer.classList.add('loaded');
            }
        }
        
        /**
         * æ‰€æœ‰ç»„ä»¶åŠ è½½å®Œæˆå¤„ç†
         */
        onAllComponentsLoaded() {
            this.log('æ‰€æœ‰ç»„ä»¶åŠ è½½å®Œæˆ');
            this.metrics.allComponentsLoadedTime = performance.now();
            this.componentsRendered = true;
            
            // æ˜¾ç¤ºé¡µé¢å†…å®¹
            setTimeout(() => {
                this.showPageContent();
            }, CONFIG.loadingHideDelay);
        }
        
        /**
         * ä¼˜åŒ–ç»„ä»¶æ¸²æŸ“
         */
        optimizeComponentRendering() {
            this.log('ä¼˜åŒ–ç»„ä»¶æ¸²æŸ“...');
            
            // æ£€æŸ¥ç»„ä»¶ç®¡ç†å™¨æ˜¯å¦å­˜åœ¨
            if (window.componentManager) {
                this.log('ä½¿ç”¨ç°æœ‰ç»„ä»¶ç®¡ç†å™¨');
            } else {
                this.log('ç»„ä»¶ç®¡ç†å™¨ä¸å­˜åœ¨ï¼Œç­‰å¾…åŠ è½½...', 'warn');
                
                // ç­‰å¾…ç»„ä»¶ç®¡ç†å™¨åŠ è½½
                const checkComponentManager = () => {
                    if (window.componentManager) {
                        this.log('ç»„ä»¶ç®¡ç†å™¨å·²åŠ è½½', 'success');
                    } else {
                        setTimeout(checkComponentManager, 100);
                    }
                };
                
                checkComponentManager();
            }
        }
        
        /**
         * æ˜¾ç¤ºé¡µé¢å†…å®¹
         */
        showPageContent() {
            if (this.loadingScreenHidden) return;
            
            this.log('æ˜¾ç¤ºé¡µé¢å†…å®¹...');
            
            const loadingScreen = document.querySelector(CONFIG.loadingScreenSelector);
            const header = document.querySelector(CONFIG.headerSelector);
            const footer = document.querySelector(CONFIG.footerSelector);
            
            // ç¡®ä¿ç»„ä»¶å¯è§
            if (header) header.classList.add('loaded');
            if (footer) footer.classList.add('loaded');
            
            // å¹³æ»‘éšè—åŠ è½½å±å¹•
            if (loadingScreen) {
                loadingScreen.classList.add('hiding');
                
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    loadingScreen.style.display = 'none';
                    
                    // ç§»é™¤å…³é”®æ ·å¼
                    const criticalStyles = document.getElementById('critical-styles');
                    if (criticalStyles) {
                        criticalStyles.remove();
                    }
                    
                    this.log('åŠ è½½å±å¹•å·²éšè—', 'success');
                    this.loadingScreenHidden = true;
                    
                    // è®°å½•å®Œæˆæ—¶é—´
                    this.metrics.contentShownTime = performance.now();
                    
                    // ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
                    this.generatePerformanceReport();
                    
                }, CONFIG.smoothTransitionDuration);
            }
        }
        
        /**
         * ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
         */
        generatePerformanceReport() {
            const totalTime = this.metrics.contentShownTime - this.loadStartTime;
            
            const report = {
                totalLoadTime: Math.round(totalTime),
                domContentLoadedTime: Math.round(this.metrics.domContentLoadedTime - this.loadStartTime),
                pageLoadTime: Math.round(this.metrics.pageLoadTime - this.loadStartTime),
                headerLoadedTime: this.metrics.headerLoadedTime ? Math.round(this.metrics.headerLoadedTime - this.loadStartTime) : null,
                footerLoadedTime: this.metrics.footerLoadedTime ? Math.round(this.metrics.footerLoadedTime - this.loadStartTime) : null,
                allComponentsLoadedTime: this.metrics.allComponentsLoadedTime ? Math.round(this.metrics.allComponentsLoadedTime - this.loadStartTime) : null,
                contentShownTime: Math.round(this.metrics.contentShownTime - this.loadStartTime)
            };
            
            this.log('é¡µé¢åŠ è½½æ€§èƒ½æŠ¥å‘Š:', 'success');
            this.log(`æ€»åŠ è½½æ—¶é—´: ${report.totalLoadTime}ms`);
            this.log(`DOMåŠ è½½: ${report.domContentLoadedTime}ms`);
            this.log(`é¡µé¢åŠ è½½: ${report.pageLoadTime}ms`);
            this.log(`å†…å®¹æ˜¾ç¤º: ${report.contentShownTime}ms`);
            
            // ä¿å­˜åˆ°å…¨å±€å˜é‡
            window.pageLoadPerformanceReport = report;
            
            // è§¦å‘æ€§èƒ½æŠ¥å‘Šäº‹ä»¶
            const event = new CustomEvent('pageLoadPerformanceReport', {
                detail: report
            });
            document.dispatchEvent(event);
        }
        
        /**
         * æ‰‹åŠ¨æ˜¾ç¤ºå†…å®¹ï¼ˆè°ƒè¯•ç”¨ï¼‰
         */
        forceShowContent() {
            this.log('å¼ºåˆ¶æ˜¾ç¤ºå†…å®¹');
            this.showPageContent();
        }
        
        /**
         * è·å–æ€§èƒ½æŒ‡æ ‡
         */
        getMetrics() {
            return this.metrics;
        }
    }
    
    // åˆ›å»ºå…¨å±€å®ä¾‹
    window.pageLoadOptimizer = new PageLoadOptimizer();
    
    // ç«‹å³åˆå§‹åŒ–
    window.pageLoadOptimizer.init();
    
    // å¯¼å‡ºè°ƒè¯•æ¥å£
    if (CONFIG.debug) {
        window.pageLoadOptimizerDebug = {
            forceShow: () => window.pageLoadOptimizer.forceShowContent(),
            metrics: () => window.pageLoadOptimizer.getMetrics(),
            report: () => window.pageLoadPerformanceReport
        };
    }
    
    console.log('ğŸ“ˆ é¡µé¢åŠ è½½ä¼˜åŒ–å™¨å·²å¯åŠ¨');
    
})();
