<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœç´¢ä¿®å¤æ–¹æ¡ˆæ€§èƒ½å¯¹æ¯”æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .title {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
            margin-bottom: 25px;
            font-size: 28px;
            font-weight: 700;
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .comparison-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        .comparison-card:hover {
            border-color: #007bff;
            transform: translateY(-2px);
        }
        .comparison-card.current {
            border-color: #dc3545;
            background: #fff5f5;
        }
        .comparison-card.optimized {
            border-color: #28a745;
            background: #f8fff9;
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .metric-row:last-child {
            border-bottom: none;
        }
        .metric-label {
            font-weight: 500;
        }
        .metric-value {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .metric-value.good {
            background: #d4edda;
            color: #155724;
        }
        .metric-value.warning {
            background: #fff3cd;
            color: #856404;
        }
        .metric-value.danger {
            background: #f8d7da;
            color: #721c24;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        .btn.success { background: #28a745; }
        .btn.success:hover { background: #1e7e34; }
        .btn.danger { background: #dc3545; }
        .btn.danger:hover { background: #c82333; }
        .performance-chart {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .chart-bar {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .chart-label {
            width: 150px;
            font-weight: 500;
        }
        .chart-bar-container {
            flex: 1;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 0 10px;
        }
        .chart-bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        .chart-bar-fill.current {
            background: linear-gradient(90deg, #dc3545, #c82333);
        }
        .chart-bar-fill.optimized {
            background: linear-gradient(90deg, #28a745, #1e7e34);
        }
        .chart-value {
            width: 80px;
            text-align: right;
            font-weight: 600;
        }
        .test-results {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .iframe-container {
            border: 3px solid #dee2e6;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .iframe-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        iframe {
            width: 100%;
            height: 500px;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">ğŸ“Š æœç´¢ä¿®å¤æ–¹æ¡ˆæ€§èƒ½å¯¹æ¯”æµ‹è¯•</h1>
        
        <div class="btn-group">
            <button class="btn" onclick="loadCurrentVersion()">
                <span>ğŸ”´</span>åŠ è½½å½“å‰ç‰ˆæœ¬ (å¤šè„šæœ¬)
            </button>
            <button class="btn success" onclick="loadOptimizedVersion()">
                <span>ğŸŸ¢</span>åŠ è½½ä¼˜åŒ–ç‰ˆæœ¬ (è½»é‡çº§)
            </button>
            <button class="btn" onclick="runPerformanceTest()">
                <span>ğŸ§ª</span>è¿è¡Œæ€§èƒ½æµ‹è¯•
            </button>
            <button class="btn" onclick="generateReport()">
                <span>ğŸ“Š</span>ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š
            </button>
        </div>

        <div class="comparison-grid">
            <div class="comparison-card current">
                <div class="card-title">
                    <span>ğŸ”´</span>å½“å‰æ–¹æ¡ˆ (å¤šè„šæœ¬)
                </div>
                <div class="metric-row">
                    <span class="metric-label">æ–‡ä»¶æ•°é‡</span>
                    <span class="metric-value danger">3ä¸ª</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">æ€»æ–‡ä»¶å¤§å°</span>
                    <span class="metric-value danger">47 KB</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">å‹ç¼©åå¤§å°</span>
                    <span class="metric-value warning">~14 KB</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">é¢„ä¼°åŠ è½½æ—¶é—´</span>
                    <span class="metric-value danger">100-300ms</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">æ‰§è¡Œæ—¶é—´</span>
                    <span class="metric-value warning">20-50ms</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">å†…å­˜å ç”¨</span>
                    <span class="metric-value danger">~500 KB</span>
                </div>
            </div>

            <div class="comparison-card optimized">
                <div class="card-title">
                    <span>ğŸŸ¢</span>ä¼˜åŒ–æ–¹æ¡ˆ (è½»é‡çº§)
                </div>
                <div class="metric-row">
                    <span class="metric-label">æ–‡ä»¶æ•°é‡</span>
                    <span class="metric-value good">1ä¸ª</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">æ€»æ–‡ä»¶å¤§å°</span>
                    <span class="metric-value good">3 KB</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">å‹ç¼©åå¤§å°</span>
                    <span class="metric-value good">~1 KB</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">é¢„ä¼°åŠ è½½æ—¶é—´</span>
                    <span class="metric-value good">10-30ms</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">æ‰§è¡Œæ—¶é—´</span>
                    <span class="metric-value good">2-5ms</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">å†…å­˜å ç”¨</span>
                    <span class="metric-value good">~50 KB</span>
                </div>
            </div>
        </div>

        <div class="performance-chart">
            <h3>ğŸ“ˆ æ€§èƒ½å¯¹æ¯”å›¾è¡¨</h3>
            
            <div class="chart-bar">
                <div class="chart-label">æ–‡ä»¶å¤§å°</div>
                <div class="chart-bar-container">
                    <div class="chart-bar-fill current" style="width: 100%"></div>
                </div>
                <div class="chart-value">47 KB</div>
            </div>
            
            <div class="chart-bar">
                <div class="chart-label"></div>
                <div class="chart-bar-container">
                    <div class="chart-bar-fill optimized" style="width: 6.4%"></div>
                </div>
                <div class="chart-value">3 KB</div>
            </div>
            
            <div class="chart-bar">
                <div class="chart-label">åŠ è½½æ—¶é—´</div>
                <div class="chart-bar-container">
                    <div class="chart-bar-fill current" style="width: 100%"></div>
                </div>
                <div class="chart-value">200ms</div>
            </div>
            
            <div class="chart-bar">
                <div class="chart-label"></div>
                <div class="chart-bar-container">
                    <div class="chart-bar-fill optimized" style="width: 10%"></div>
                </div>
                <div class="chart-value">20ms</div>
            </div>
            
            <div class="chart-bar">
                <div class="chart-label">å†…å­˜å ç”¨</div>
                <div class="chart-bar-container">
                    <div class="chart-bar-fill current" style="width: 100%"></div>
                </div>
                <div class="chart-value">500 KB</div>
            </div>
            
            <div class="chart-bar">
                <div class="chart-label"></div>
                <div class="chart-bar-container">
                    <div class="chart-bar-fill optimized" style="width: 10%"></div>
                </div>
                <div class="chart-value">50 KB</div>
            </div>
        </div>

        <div class="test-results" id="testResults">
            <div style="color: #50fa7b;">âœ… æ€§èƒ½å¯¹æ¯”æµ‹è¯•ç³»ç»Ÿå·²å°±ç»ª</div>
            <div style="color: #8be9fd;">ğŸ“‹ ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•ä¸åŒç‰ˆæœ¬çš„æ€§èƒ½</div>
            <div style="color: #ffb86c;">ğŸ¯ å»ºè®®: å…ˆæµ‹è¯•å½“å‰ç‰ˆæœ¬ï¼Œå†æµ‹è¯•ä¼˜åŒ–ç‰ˆæœ¬è¿›è¡Œå¯¹æ¯”</div>
        </div>
    </div>

    <div class="container">
        <h2 class="title">ğŸŒ å®æ—¶æ€§èƒ½æµ‹è¯•</h2>
        
        <div class="iframe-container">
            <div class="iframe-header">
                <span id="iframe-title">ğŸŒ ç­‰å¾…åŠ è½½æµ‹è¯•é¡µé¢</span>
                <span id="iframe-status">æœªåŠ è½½</span>
            </div>
            <iframe id="testFrame" src="about:blank"></iframe>
        </div>
    </div>

    <script>
        let currentTest = null;
        let testResults = {
            current: null,
            optimized: null
        };

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const output = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            let color = '#f8f8f2';
            let icon = 'ğŸ“';
            
            switch(type) {
                case 'success':
                    color = '#50fa7b';
                    icon = 'âœ…';
                    break;
                case 'error':
                    color = '#ff5555';
                    icon = 'âŒ';
                    break;
                case 'warning':
                    color = '#ffb86c';
                    icon = 'âš ï¸';
                    break;
                case 'info':
                    color = '#8be9fd';
                    icon = 'ğŸ“';
                    break;
            }
            
            const logEntry = document.createElement('div');
            logEntry.style.color = color;
            logEntry.innerHTML = `[${timestamp}] ${icon} ${message}`;
            output.appendChild(logEntry);
            output.scrollTop = output.scrollHeight;
        }

        // åŠ è½½å½“å‰ç‰ˆæœ¬ (å¤šè„šæœ¬)
        function loadCurrentVersion() {
            log('åŠ è½½å½“å‰ç‰ˆæœ¬ (å¤šè„šæœ¬æ–¹æ¡ˆ)...', 'info');
            currentTest = 'current';
            
            const iframe = document.getElementById('testFrame');
            const title = document.getElementById('iframe-title');
            const status = document.getElementById('iframe-status');
            
            title.textContent = 'ğŸ”´ å½“å‰ç‰ˆæœ¬ (å¤šè„šæœ¬)';
            status.textContent = 'åŠ è½½ä¸­...';
            
            // åˆ›å»ºåŒ…å«å¤šä¸ªä¿®å¤è„šæœ¬çš„æµ‹è¯•é¡µé¢
            const testPageContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>å½“å‰ç‰ˆæœ¬æµ‹è¯•</title>
                    <script>
                        window.testStartTime = performance.now();
                        window.testMetrics = {};
                    </script>
                </head>
                <body>
                    <div id="searchInput" style="padding: 20px;">
                        <input type="text" id="searchInput" placeholder="æœç´¢æµ‹è¯•" style="padding: 10px; width: 300px;">
                        <button class="search-btn" style="padding: 10px;">æœç´¢</button>
                        <div id="searchResults" style="margin-top: 20px;"></div>
                    </div>
                    
                    <!-- æ¨¡æ‹Ÿå½“å‰çš„å¤šè„šæœ¬åŠ è½½ -->
                    <script src="search-enter-key-fix.js"></script>
                    <script src="deep-search-diagnosis.js"></script>
                    <script src="advanced-search-fix.js"></script>
                    <script src="performance-monitor.js"></script>
                    
                    <script>
                        window.addEventListener('load', function() {
                            window.testMetrics.loadTime = performance.now() - window.testStartTime;
                            window.testMetrics.memoryUsage = performance.memory ? performance.memory.usedJSHeapSize : 0;
                            window.testMetrics.scriptCount = document.scripts.length;
                            
                            parent.postMessage({
                                type: 'testComplete',
                                version: 'current',
                                metrics: window.testMetrics
                            }, '*');
                        });
                    </script>
                </body>
                </html>
            `;
            
            iframe.srcdoc = testPageContent;
            
            iframe.onload = function() {
                log('å½“å‰ç‰ˆæœ¬åŠ è½½å®Œæˆ', 'success');
                status.textContent = 'å·²åŠ è½½';
            };
        }

        // åŠ è½½ä¼˜åŒ–ç‰ˆæœ¬ (è½»é‡çº§)
        function loadOptimizedVersion() {
            log('åŠ è½½ä¼˜åŒ–ç‰ˆæœ¬ (è½»é‡çº§æ–¹æ¡ˆ)...', 'info');
            currentTest = 'optimized';
            
            const iframe = document.getElementById('testFrame');
            const title = document.getElementById('iframe-title');
            const status = document.getElementById('iframe-status');
            
            title.textContent = 'ğŸŸ¢ ä¼˜åŒ–ç‰ˆæœ¬ (è½»é‡çº§)';
            status.textContent = 'åŠ è½½ä¸­...';
            
            // åˆ›å»ºåŒ…å«è½»é‡çº§ä¿®å¤è„šæœ¬çš„æµ‹è¯•é¡µé¢
            const testPageContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>ä¼˜åŒ–ç‰ˆæœ¬æµ‹è¯•</title>
                    <script>
                        window.testStartTime = performance.now();
                        window.testMetrics = {};
                    </script>
                </head>
                <body>
                    <div style="padding: 20px;">
                        <input type="text" id="searchInput" placeholder="æœç´¢æµ‹è¯•" style="padding: 10px; width: 300px;">
                        <button class="search-btn" style="padding: 10px;">æœç´¢</button>
                        <div id="searchResults" style="margin-top: 20px;"></div>
                    </div>
                    
                    <!-- è½»é‡çº§ä¿®å¤è„šæœ¬ -->
                    <script src="lightweight-search-fix.js"></script>
                    
                    <script>
                        window.addEventListener('load', function() {
                            window.testMetrics.loadTime = performance.now() - window.testStartTime;
                            window.testMetrics.memoryUsage = performance.memory ? performance.memory.usedJSHeapSize : 0;
                            window.testMetrics.scriptCount = document.scripts.length;
                            
                            parent.postMessage({
                                type: 'testComplete',
                                version: 'optimized',
                                metrics: window.testMetrics
                            }, '*');
                        });
                    </script>
                </body>
                </html>
            `;
            
            iframe.srcdoc = testPageContent;
            
            iframe.onload = function() {
                log('ä¼˜åŒ–ç‰ˆæœ¬åŠ è½½å®Œæˆ', 'success');
                status.textContent = 'å·²åŠ è½½';
            };
        }

        // è¿è¡Œæ€§èƒ½æµ‹è¯•
        function runPerformanceTest() {
            log('å¼€å§‹è¿è¡Œæ€§èƒ½æµ‹è¯•...', 'info');
            
            if (!currentTest) {
                log('è¯·å…ˆåŠ è½½ä¸€ä¸ªæµ‹è¯•ç‰ˆæœ¬', 'warning');
                return;
            }
            
            const iframe = document.getElementById('testFrame');
            const iframeWindow = iframe.contentWindow;
            
            if (iframeWindow && iframeWindow.performanceMonitor) {
                const report = iframeWindow.performanceMonitor.generateReport();
                log(`æ€§èƒ½æµ‹è¯•å®Œæˆ - ${currentTest}ç‰ˆæœ¬`, 'success');
                log(`åŠ è½½æ—¶é—´: ${report.metrics.pageLoadTime?.value || 'N/A'}ms`, 'info');
                log(`å†…å­˜ä½¿ç”¨: ${report.metrics.usedJSHeapSize?.value || 'N/A'}MB`, 'info');
                
                testResults[currentTest] = report;
            } else {
                log('æ€§èƒ½ç›‘æ§å™¨æœªæ‰¾åˆ°ï¼Œä½¿ç”¨åŸºç¡€æŒ‡æ ‡', 'warning');
            }
        }

        // ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š
        function generateReport() {
            log('ç”Ÿæˆæ€§èƒ½å¯¹æ¯”æŠ¥å‘Š...', 'info');
            
            if (!testResults.current && !testResults.optimized) {
                log('è¯·å…ˆè¿è¡Œä¸¤ä¸ªç‰ˆæœ¬çš„æµ‹è¯•', 'warning');
                return;
            }
            
            const report = {
                timestamp: new Date().toISOString(),
                current: testResults.current,
                optimized: testResults.optimized,
                comparison: {}
            };
            
            if (testResults.current && testResults.optimized) {
                const currentLoad = testResults.current.metrics.pageLoadTime?.value || 0;
                const optimizedLoad = testResults.optimized.metrics.pageLoadTime?.value || 0;
                const loadImprovement = currentLoad > 0 ? ((currentLoad - optimizedLoad) / currentLoad * 100) : 0;
                
                const currentMemory = testResults.current.metrics.usedJSHeapSize?.value || 0;
                const optimizedMemory = testResults.optimized.metrics.usedJSHeapSize?.value || 0;
                const memoryImprovement = currentMemory > 0 ? ((currentMemory - optimizedMemory) / currentMemory * 100) : 0;
                
                report.comparison = {
                    loadTimeImprovement: Math.round(loadImprovement * 100) / 100,
                    memoryImprovement: Math.round(memoryImprovement * 100) / 100,
                    fileSizeReduction: 93.6, // 47KB -> 3KB
                    requestReduction: 66.7   // 3 requests -> 1 request
                };
                
                log('ğŸ“Š æ€§èƒ½å¯¹æ¯”ç»“æœ:', 'success');
                log(`åŠ è½½æ—¶é—´æ”¹å–„: ${report.comparison.loadTimeImprovement}%`, 'success');
                log(`å†…å­˜ä½¿ç”¨æ”¹å–„: ${report.comparison.memoryImprovement}%`, 'success');
                log(`æ–‡ä»¶å¤§å°å‡å°‘: ${report.comparison.fileSizeReduction}%`, 'success');
                log(`è¯·æ±‚æ•°é‡å‡å°‘: ${report.comparison.requestReduction}%`, 'success');
            }
            
            window.performanceComparisonReport = report;
            log('å®Œæ•´æŠ¥å‘Šå·²ä¿å­˜åˆ°: window.performanceComparisonReport', 'info');
        }

        // ç›‘å¬iframeæ¶ˆæ¯
        window.addEventListener('message', function(event) {
            if (event.data.type === 'testComplete') {
                const version = event.data.version;
                const metrics = event.data.metrics;
                
                log(`${version}ç‰ˆæœ¬æµ‹è¯•å®Œæˆ`, 'success');
                log(`åŠ è½½æ—¶é—´: ${Math.round(metrics.loadTime)}ms`, 'info');
                log(`å†…å­˜ä½¿ç”¨: ${Math.round(metrics.memoryUsage / 1024 / 1024 * 100) / 100}MB`, 'info');
                log(`è„šæœ¬æ•°é‡: ${metrics.scriptCount}ä¸ª`, 'info');
                
                testResults[version] = {
                    metrics: {
                        pageLoadTime: { value: metrics.loadTime },
                        usedJSHeapSize: { value: metrics.memoryUsage / 1024 / 1024 },
                        scriptCount: { value: metrics.scriptCount }
                    }
                };
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('load', function() {
            log('ğŸš€ æ€§èƒ½å¯¹æ¯”æµ‹è¯•ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'success');
            log('ğŸ’¡ å»ºè®®æµ‹è¯•æµç¨‹:', 'info');
            log('1. åŠ è½½å½“å‰ç‰ˆæœ¬ â†’ 2. è¿è¡Œæ€§èƒ½æµ‹è¯• â†’ 3. åŠ è½½ä¼˜åŒ–ç‰ˆæœ¬ â†’ 4. è¿è¡Œæ€§èƒ½æµ‹è¯• â†’ 5. ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š', 'info');
        });
    </script>
</body>
</html>
