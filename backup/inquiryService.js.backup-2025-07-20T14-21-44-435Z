// ğŸ’¬ è¯¢ä»·æœåŠ¡å±‚
// å¤„ç†å®¢æˆ·è¯¢ä»·ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘

const BaseService = require('./baseService');
const dao = require('../dao');
const utils = require('../utils');

class InquiryService extends BaseService {
  constructor() {
    super(dao.getInquiryDao());
    this.productDao = dao.getProductDao();
    this.analyticsDao = dao.getAnalyticsDao();
  }

  /**
   * è·å–è¯¢ä»·åˆ—è¡¨
   * @param {Object} options - æŸ¥è¯¢é€‰é¡¹
   * @returns {Object} è¯¢ä»·åˆ—è¡¨å“åº”
   */
  async getInquiries(options = {}) {
    try {
      this.logOperation('get_inquiries', 'è·å–è¯¢ä»·åˆ—è¡¨', options);
      
      const result = this.dao.findAll(options);
      
      // æ·»åŠ äº§å“ä¿¡æ¯
      if (result.data && result.data.length > 0) {
        const products = this.productDao.read();
        const productMap = {};
        products.forEach(product => {
          productMap[product.id] = product;
        });

        result.data = result.data.map(inquiry => ({
          ...inquiry,
          productInfo: inquiry.productId ? productMap[inquiry.productId] : null
        }));
      }

      return this.success(result, 'è·å–è¯¢ä»·åˆ—è¡¨æˆåŠŸ');
    } catch (error) {
      console.error('âŒ è·å–è¯¢ä»·åˆ—è¡¨å¤±è´¥:', error);
      return this.error(['è·å–è¯¢ä»·åˆ—è¡¨å¤±è´¥'], 'æœåŠ¡å™¨é”™è¯¯');
    }
  }

  /**
   * è·å–å•ä¸ªè¯¢ä»·
   * @param {string} id - è¯¢ä»·ID
   * @returns {Object} è¯¢ä»·è¯¦æƒ…å“åº”
   */
  async getInquiry(id) {
    try {
      this.logOperation('get_inquiry', 'è·å–è¯¢ä»·è¯¦æƒ…', { id });
      
      if (!id) {
        return this.error(['è¯¢ä»·IDä¸èƒ½ä¸ºç©º'], 'å‚æ•°é”™è¯¯');
      }

      const inquiry = this.dao.findById(id);
      
      if (!inquiry) {
        return this.error(['è¯¢ä»·è®°å½•ä¸å­˜åœ¨'], 'è¯¢ä»·æœªæ‰¾åˆ°');
      }

      // æ·»åŠ äº§å“ä¿¡æ¯
      let inquiryWithProduct = { ...inquiry };
      if (inquiry.productId) {
        const product = this.productDao.findById(inquiry.productId);
        inquiryWithProduct.productInfo = product;
      }

      return this.success(inquiryWithProduct, 'è·å–è¯¢ä»·è¯¦æƒ…æˆåŠŸ');
    } catch (error) {
      console.error('âŒ è·å–è¯¢ä»·è¯¦æƒ…å¤±è´¥:', error);
      return this.error(['è·å–è¯¢ä»·è¯¦æƒ…å¤±è´¥'], 'æœåŠ¡å™¨é”™è¯¯');
    }
  }

  /**
   * åˆ›å»ºè¯¢ä»·
   * @param {Object} inquiryData - è¯¢ä»·æ•°æ®
   * @returns {Object} åˆ›å»ºç»“æœå“åº”
   */
  async createInquiry(inquiryData) {
    try {
      this.logOperation('create_inquiry', 'åˆ›å»ºè¯¢ä»·', inquiryData);
      
      // éªŒè¯å¿…å¡«å­—æ®µ
      const requiredFields = ['name', 'email', 'message'];
      const validation = this.validateRequired(inquiryData, requiredFields);
      
      if (!validation.isValid) {
        return this.error(validation.errors, 'æ•°æ®éªŒè¯å¤±è´¥');
      }

      // éªŒè¯é‚®ç®±æ ¼å¼
      if (!utils.isValidEmail(inquiryData.email)) {
        return this.error(['é‚®ç®±æ ¼å¼ä¸æ­£ç¡®'], 'æ•°æ®éªŒè¯å¤±è´¥');
      }

      // éªŒè¯æ‰‹æœºå·ï¼ˆå¦‚æœæä¾›ï¼‰
      if (inquiryData.phone && !utils.isValidPhone(inquiryData.phone)) {
        return this.error(['æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®'], 'æ•°æ®éªŒè¯å¤±è´¥');
      }

      // éªŒè¯æ¶ˆæ¯é•¿åº¦
      if (!utils.isValidLength(inquiryData.message, 10, 2000)) {
        return this.error(['è¯¢ä»·å†…å®¹é•¿åº¦å¿…é¡»åœ¨10-2000å­—ç¬¦ä¹‹é—´'], 'æ•°æ®éªŒè¯å¤±è´¥');
      }

      // éªŒè¯äº§å“IDï¼ˆå¦‚æœæä¾›ï¼‰
      if (inquiryData.productId) {
        const product = this.productDao.findById(inquiryData.productId);
        if (!product) {
          return this.error(['æŒ‡å®šçš„äº§å“ä¸å­˜åœ¨'], 'äº§å“éªŒè¯å¤±è´¥');
        }
        // è‡ªåŠ¨å¡«å……äº§å“åç§°
        inquiryData.productName = product.name;
      }

      // æ¸…ç†å’ŒéªŒè¯æ•°æ®
      const allowedFields = [
        'name', 'email', 'phone', 'company', 'message',
        'productId', 'productName', 'source', 'priority',
        'userAgent', 'ip', 'referer'
      ];
      
      const cleanData = this.sanitizeData(inquiryData, allowedFields);
      
      // è®¾ç½®é»˜è®¤å€¼
      cleanData.source = cleanData.source || 'website';
      cleanData.priority = cleanData.priority || 'normal';

      // ååƒåœ¾é‚®ä»¶æ£€æŸ¥
      const spamCheck = this.checkSpam(cleanData);
      if (spamCheck.isSpam) {
        return this.error(['è¯¢ä»·å†…å®¹å¯èƒ½åŒ…å«åƒåœ¾ä¿¡æ¯'], 'å†…å®¹éªŒè¯å¤±è´¥');
      }

      // åˆ›å»ºè¯¢ä»·
      const result = await this.dao.create(cleanData);
      
      if (!result.success) {
        return this.error(result.errors, 'åˆ›å»ºè¯¢ä»·å¤±è´¥');
      }

      // è®°å½•åˆ†ææ•°æ®
      this.analyticsDao.recordVisit({
        type: 'inquiry',
        source: cleanData.source,
        referer: cleanData.referer,
        country: 'CN' // å¯ä»¥æ ¹æ®IPè·å–åœ°ç†ä½ç½®
      });

      return this.success({
        id: result.data.id,
        name: result.data.name,
        email: result.data.email,
        createdAt: result.data.createdAt
      }, 'è¯¢ä»·æäº¤æˆåŠŸï¼Œæˆ‘ä»¬ä¼šå°½å¿«ä¸æ‚¨è”ç³»');
    } catch (error) {
      console.error('âŒ åˆ›å»ºè¯¢ä»·å¤±è´¥:', error);
      return this.error(['è¯¢ä»·æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'], 'æœåŠ¡å™¨é”™è¯¯');
    }
  }

  /**
   * æ›´æ–°è¯¢ä»·çŠ¶æ€
   * @param {string} id - è¯¢ä»·ID
   * @param {string} status - æ–°çŠ¶æ€
   * @param {string} notes - å¤‡æ³¨
   * @returns {Object} æ›´æ–°ç»“æœå“åº”
   */
  async updateInquiryStatus(id, status, notes = '') {
    try {
      this.logOperation('update_inquiry_status', 'æ›´æ–°è¯¢ä»·çŠ¶æ€', { id, status, notes });
      
      if (!id) {
        return this.error(['è¯¢ä»·IDä¸èƒ½ä¸ºç©º'], 'å‚æ•°é”™è¯¯');
      }

      if (!status) {
        return this.error(['çŠ¶æ€ä¸èƒ½ä¸ºç©º'], 'å‚æ•°é”™è¯¯');
      }

      const validStatuses = ['pending', 'processing', 'completed', 'cancelled'];
      if (!validStatuses.includes(status)) {
        return this.error(['æ— æ•ˆçš„çŠ¶æ€å€¼'], 'å‚æ•°é”™è¯¯');
      }

      // æ£€æŸ¥è¯¢ä»·æ˜¯å¦å­˜åœ¨
      const existingInquiry = this.dao.findById(id);
      if (!existingInquiry) {
        return this.error(['è¯¢ä»·è®°å½•ä¸å­˜åœ¨'], 'è¯¢ä»·æœªæ‰¾åˆ°');
      }

      // æ›´æ–°çŠ¶æ€
      const result = await this.dao.updateStatus(id, status, notes);
      
      if (!result.success) {
        return this.error(result.errors, 'æ›´æ–°è¯¢ä»·çŠ¶æ€å¤±è´¥');
      }

      return this.success(result.data, 'è¯¢ä»·çŠ¶æ€æ›´æ–°æˆåŠŸ');
    } catch (error) {
      console.error('âŒ æ›´æ–°è¯¢ä»·çŠ¶æ€å¤±è´¥:', error);
      return this.error(['æ›´æ–°è¯¢ä»·çŠ¶æ€å¤±è´¥'], 'æœåŠ¡å™¨é”™è¯¯');
    }
  }

  /**
   * åˆ é™¤è¯¢ä»·
   * @param {string} id - è¯¢ä»·ID
   * @returns {Object} åˆ é™¤ç»“æœå“åº”
   */
  async deleteInquiry(id) {
    try {
      this.logOperation('delete_inquiry', 'åˆ é™¤è¯¢ä»·', { id });
      
      if (!id) {
        return this.error(['è¯¢ä»·IDä¸èƒ½ä¸ºç©º'], 'å‚æ•°é”™è¯¯');
      }

      // æ£€æŸ¥è¯¢ä»·æ˜¯å¦å­˜åœ¨
      const existingInquiry = this.dao.findById(id);
      if (!existingInquiry) {
        return this.error(['è¯¢ä»·è®°å½•ä¸å­˜åœ¨'], 'è¯¢ä»·æœªæ‰¾åˆ°');
      }

      // åˆ é™¤è¯¢ä»·
      const result = await this.dao.delete(id);
      
      if (!result.success) {
        return this.error(result.errors, 'åˆ é™¤è¯¢ä»·å¤±è´¥');
      }

      return this.success(result.data, 'è¯¢ä»·åˆ é™¤æˆåŠŸ');
    } catch (error) {
      console.error('âŒ åˆ é™¤è¯¢ä»·å¤±è´¥:', error);
      return this.error(['åˆ é™¤è¯¢ä»·å¤±è´¥'], 'æœåŠ¡å™¨é”™è¯¯');
    }
  }

  /**
   * è·å–è¯¢ä»·ç»Ÿè®¡ä¿¡æ¯
   * @returns {Object} ç»Ÿè®¡ä¿¡æ¯å“åº”
   */
  async getInquiryStats() {
    try {
      this.logOperation('get_inquiry_stats', 'è·å–è¯¢ä»·ç»Ÿè®¡');
      
      const stats = this.dao.getInquiryStats();
      
      if (!stats) {
        return this.error(['è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥'], 'æœåŠ¡å™¨é”™è¯¯');
      }

      // æ·»åŠ é¢å¤–çš„ç»Ÿè®¡ä¿¡æ¯
      const inquiries = this.dao.read();
      const enhancedStats = {
        ...stats,
        todayInquiries: inquiries.filter(inquiry => 
          utils.isToday(new Date(inquiry.createdAt))
        ).length,
        responseRate: stats.completed > 0 ? 
          ((stats.completed / stats.total) * 100).toFixed(2) : 0
      };

      return this.success(enhancedStats, 'è·å–è¯¢ä»·ç»Ÿè®¡æˆåŠŸ');
    } catch (error) {
      console.error('âŒ è·å–è¯¢ä»·ç»Ÿè®¡å¤±è´¥:', error);
      return this.error(['è·å–è¯¢ä»·ç»Ÿè®¡å¤±è´¥'], 'æœåŠ¡å™¨é”™è¯¯');
    }
  }

  /**
   * æ‰¹é‡æ“ä½œè¯¢ä»·
   * @param {string} action - æ“ä½œç±»å‹
   * @param {Array} inquiryIds - è¯¢ä»·IDåˆ—è¡¨
   * @param {Object} data - æ“ä½œæ•°æ®
   * @returns {Object} æ‰¹é‡æ“ä½œç»“æœå“åº”
   */
  async batchOperation(action, inquiryIds, data = {}) {
    try {
      this.logOperation('batch_operation', 'æ‰¹é‡æ“ä½œè¯¢ä»·', { action, inquiryIds, data });
      
      if (!action || !Array.isArray(inquiryIds) || inquiryIds.length === 0) {
        return this.error(['æ‰¹é‡æ“ä½œå‚æ•°ä¸å®Œæ•´'], 'å‚æ•°é”™è¯¯');
      }

      const operations = {
        updateStatus: (id) => this.dao.updateStatus(id, data.status, data.notes),
        delete: (id) => this.dao.delete(id)
      };

      const operation = operations[action];
      if (!operation) {
        return this.error([`ä¸æ”¯æŒçš„æ‰¹é‡æ“ä½œ: ${action}`], 'æ“ä½œä¸æ”¯æŒ');
      }

      const result = await this.batchOperation(inquiryIds, operation);
      
      return this.success(result, `æ‰¹é‡${action}æ“ä½œå®Œæˆ`);
    } catch (error) {
      console.error('âŒ æ‰¹é‡æ“ä½œå¤±è´¥:', error);
      return this.error(['æ‰¹é‡æ“ä½œå¤±è´¥'], 'æœåŠ¡å™¨é”™è¯¯');
    }
  }

  /**
   * å¯¼å‡ºè¯¢ä»·æ•°æ®
   * @param {Object} options - å¯¼å‡ºé€‰é¡¹
   * @returns {Object} å¯¼å‡ºæ•°æ®å“åº”
   */
  async exportInquiries(options = {}) {
    try {
      this.logOperation('export_inquiries', 'å¯¼å‡ºè¯¢ä»·æ•°æ®', options);
      
      const exportData = this.dao.exportData(options);
      
      return this.success(exportData, 'å¯¼å‡ºè¯¢ä»·æ•°æ®æˆåŠŸ');
    } catch (error) {
      console.error('âŒ å¯¼å‡ºè¯¢ä»·æ•°æ®å¤±è´¥:', error);
      return this.error(['å¯¼å‡ºè¯¢ä»·æ•°æ®å¤±è´¥'], 'æœåŠ¡å™¨é”™è¯¯');
    }
  }

  /**
   * ååƒåœ¾é‚®ä»¶æ£€æŸ¥
   * @param {Object} inquiryData - è¯¢ä»·æ•°æ®
   * @returns {Object} æ£€æŸ¥ç»“æœ
   */
  checkSpam(inquiryData) {
    const spamKeywords = [
      'viagra', 'casino', 'lottery', 'winner', 'congratulations',
      'ä¸­å¥–', 'æ­å–œ', 'å…è´¹', 'èµšé’±', 'æŠ•èµ„'
    ];

    const content = `${inquiryData.name} ${inquiryData.email} ${inquiryData.message}`.toLowerCase();
    
    const hasSpamKeywords = spamKeywords.some(keyword => 
      content.includes(keyword.toLowerCase())
    );

    // æ£€æŸ¥æ˜¯å¦åŒ…å«è¿‡å¤šé“¾æ¥
    const linkCount = (inquiryData.message.match(/https?:\/\//g) || []).length;
    const hasExcessiveLinks = linkCount > 3;

    // æ£€æŸ¥æ˜¯å¦å…¨æ˜¯å¤§å†™å­—æ¯
    const isAllCaps = inquiryData.message === inquiryData.message.toUpperCase() && 
                      inquiryData.message.length > 20;

    return {
      isSpam: hasSpamKeywords || hasExcessiveLinks || isAllCaps,
      reasons: [
        hasSpamKeywords && 'åŒ…å«åƒåœ¾å…³é”®è¯',
        hasExcessiveLinks && 'åŒ…å«è¿‡å¤šé“¾æ¥',
        isAllCaps && 'å…¨éƒ¨å¤§å†™å­—æ¯'
      ].filter(Boolean)
    };
  }
}

module.exports = InquiryService;
