<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>验证自动提示移除</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .verify-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #ccc;
            font-size: 16px;
        }
        .status-success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .status-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        .status-info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .countdown {
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="verify-container">
        <h1>🔍 验证自动提示移除</h1>
        <p><strong>验证目标：</strong> 确认页面刷新时不再显示"联系表单已就绪"的自动提示消息</p>
        <p><strong>测试时间：</strong> <span id="testTime"></span></p>
    </div>

    <div class="verify-container">
        <h3>📊 自动提示检测</h3>
        <div id="autoMessageStatus">
            <div class="status-item status-info">
                <span>🔄 正在监控自动提示消息... <span class="countdown" id="countdown">10</span> 秒</span>
            </div>
        </div>
    </div>

    <div class="verify-container">
        <h3>🧪 表单功能验证</h3>
        <p>请点击下面的按钮测试表单提交功能是否仍然正常：</p>
        <button class="test-button" onclick="testFormFunction()">测试表单提交功能</button>
        <div id="formFunctionStatus">
            <div class="status-item status-info">
                <span>⏳ 等待测试...</span>
            </div>
        </div>
    </div>

    <div class="verify-container">
        <h3>📋 验证结果</h3>
        <div id="verificationResult">
            <div class="status-item status-info">
                <span>⏳ 正在进行验证...</span>
            </div>
        </div>
    </div>

    <div class="verify-container">
        <h3>🔗 快速链接</h3>
        <p>
            <a href="http://127.0.0.1:3001" target="_blank" class="test-button">打开主页</a>
            <button class="test-button" onclick="location.reload()">刷新此页面</button>
        </p>
    </div>

    <script>
        // 设置测试时间
        document.getElementById('testTime').textContent = new Date().toLocaleString('zh-CN');

        let autoMessageDetected = false;
        let countdownValue = 10;
        let countdownInterval;

        // 监控是否有自动提示消息出现
        function monitorAutoMessages() {
            // 检查是否有通知元素出现
            const notifications = document.querySelectorAll('.notification, .alert, [class*="message"], [class*="toast"]');
            const feedbackDivs = document.querySelectorAll('#contactFormFeedback, [id*="feedback"], [id*="message"]');
            
            // 检查是否有包含"联系表单已就绪"或类似文本的元素
            const allElements = document.querySelectorAll('*');
            for (let element of allElements) {
                if (element.textContent && element.textContent.includes('联系表单已就绪')) {
                    autoMessageDetected = true;
                    break;
                }
                if (element.textContent && element.textContent.includes('可以正常使用')) {
                    autoMessageDetected = true;
                    break;
                }
            }

            return autoMessageDetected;
        }

        // 更新状态显示
        function updateStatus(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="status-item status-${type}">
                    <span>${message}</span>
                </div>
            `;
        }

        // 倒计时监控
        function startCountdown() {
            const countdownElement = document.getElementById('countdown');
            
            countdownInterval = setInterval(() => {
                countdownValue--;
                if (countdownElement) {
                    countdownElement.textContent = countdownValue;
                }

                // 检查自动消息
                if (monitorAutoMessages()) {
                    clearInterval(countdownInterval);
                    updateStatus('autoMessageStatus', 
                        '❌ 检测到自动提示消息！页面仍在显示不必要的提示。', 
                        'error');
                    updateVerificationResult();
                    return;
                }

                if (countdownValue <= 0) {
                    clearInterval(countdownInterval);
                    updateStatus('autoMessageStatus', 
                        '✅ 未检测到自动提示消息！修改成功。', 
                        'success');
                    updateVerificationResult();
                }
            }, 1000);
        }

        // 测试表单功能
        async function testFormFunction() {
            updateStatus('formFunctionStatus', '🔄 正在测试表单提交功能...', 'info');

            try {
                // 检查表单是否存在
                const mainWindow = window.parent !== window ? window.parent : window;
                
                // 尝试调用表单提交功能
                if (typeof window.showContactFormMessage === 'function') {
                    // 测试成功消息显示
                    window.showContactFormMessage('测试：表单功能正常工作！', 'success');
                    
                    setTimeout(() => {
                        updateStatus('formFunctionStatus', 
                            '✅ 表单提示功能正常！可以显示成功/失败消息。', 
                            'success');
                        updateVerificationResult();
                    }, 1000);
                } else {
                    // 尝试API测试
                    const response = await fetch('/api/inquiries', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: '功能测试',
                            email: 'test@example.com',
                            message: '这是一个功能测试消息',
                            source: 'verification_test'
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        updateStatus('formFunctionStatus', 
                            '✅ 表单提交功能正常！API响应成功。', 
                            'success');
                    } else {
                        updateStatus('formFunctionStatus', 
                            '⚠️ 表单API响应异常，但连接正常。', 
                            'warning');
                    }
                    updateVerificationResult();
                }
            } catch (error) {
                updateStatus('formFunctionStatus', 
                    `❌ 表单功能测试失败: ${error.message}`, 
                    'error');
                updateVerificationResult();
            }
        }

        // 更新最终验证结果
        function updateVerificationResult() {
            const autoMessageOk = !autoMessageDetected;
            const formFunctionOk = document.getElementById('formFunctionStatus').innerHTML.includes('status-success');

            let resultMessage = '';
            let resultType = '';

            if (autoMessageOk && formFunctionOk) {
                resultMessage = '🎉 验证完成！自动提示已成功移除，表单功能正常工作。';
                resultType = 'success';
            } else if (autoMessageOk && !formFunctionOk) {
                resultMessage = '⚠️ 自动提示已移除，但表单功能需要进一步检查。';
                resultType = 'warning';
            } else if (!autoMessageOk) {
                resultMessage = '❌ 仍然检测到自动提示消息，需要进一步修复。';
                resultType = 'error';
            } else {
                resultMessage = '🔄 验证进行中...';
                resultType = 'info';
            }

            updateStatus('verificationResult', resultMessage, resultType);
        }

        // 页面加载时开始监控
        window.addEventListener('load', () => {
            console.log('🔍 开始监控自动提示消息...');
            startCountdown();
            
            // 初始检查
            setTimeout(() => {
                if (monitorAutoMessages()) {
                    clearInterval(countdownInterval);
                    updateStatus('autoMessageStatus', 
                        '❌ 页面加载时检测到自动提示消息！', 
                        'error');
                    updateVerificationResult();
                }
            }, 2000);
        });

        // 监听DOM变化
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            if (node.textContent && 
                                (node.textContent.includes('联系表单已就绪') || 
                                 node.textContent.includes('可以正常使用'))) {
                                autoMessageDetected = true;
                                clearInterval(countdownInterval);
                                updateStatus('autoMessageStatus', 
                                    '❌ 检测到自动提示消息出现！', 
                                    'error');
                                updateVerificationResult();
                            }
                        }
                    });
                }
            });
        });

        // 开始观察DOM变化
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    </script>
</body>
</html>
