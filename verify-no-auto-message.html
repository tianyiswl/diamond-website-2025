<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éªŒè¯è‡ªåŠ¨æç¤ºç§»é™¤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .verify-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #ccc;
            font-size: 16px;
        }
        .status-success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .status-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        .status-info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .countdown {
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="verify-container">
        <h1>ğŸ” éªŒè¯è‡ªåŠ¨æç¤ºç§»é™¤</h1>
        <p><strong>éªŒè¯ç›®æ ‡ï¼š</strong> ç¡®è®¤é¡µé¢åˆ·æ–°æ—¶ä¸å†æ˜¾ç¤º"è”ç³»è¡¨å•å·²å°±ç»ª"çš„è‡ªåŠ¨æç¤ºæ¶ˆæ¯</p>
        <p><strong>æµ‹è¯•æ—¶é—´ï¼š</strong> <span id="testTime"></span></p>
    </div>

    <div class="verify-container">
        <h3>ğŸ“Š è‡ªåŠ¨æç¤ºæ£€æµ‹</h3>
        <div id="autoMessageStatus">
            <div class="status-item status-info">
                <span>ğŸ”„ æ­£åœ¨ç›‘æ§è‡ªåŠ¨æç¤ºæ¶ˆæ¯... <span class="countdown" id="countdown">10</span> ç§’</span>
            </div>
        </div>
    </div>

    <div class="verify-container">
        <h3>ğŸ§ª è¡¨å•åŠŸèƒ½éªŒè¯</h3>
        <p>è¯·ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®æµ‹è¯•è¡¨å•æäº¤åŠŸèƒ½æ˜¯å¦ä»ç„¶æ­£å¸¸ï¼š</p>
        <button class="test-button" onclick="testFormFunction()">æµ‹è¯•è¡¨å•æäº¤åŠŸèƒ½</button>
        <div id="formFunctionStatus">
            <div class="status-item status-info">
                <span>â³ ç­‰å¾…æµ‹è¯•...</span>
            </div>
        </div>
    </div>

    <div class="verify-container">
        <h3>ğŸ“‹ éªŒè¯ç»“æœ</h3>
        <div id="verificationResult">
            <div class="status-item status-info">
                <span>â³ æ­£åœ¨è¿›è¡ŒéªŒè¯...</span>
            </div>
        </div>
    </div>

    <div class="verify-container">
        <h3>ğŸ”— å¿«é€Ÿé“¾æ¥</h3>
        <p>
            <a href="http://127.0.0.1:3001" target="_blank" class="test-button">æ‰“å¼€ä¸»é¡µ</a>
            <button class="test-button" onclick="location.reload()">åˆ·æ–°æ­¤é¡µé¢</button>
        </p>
    </div>

    <script>
        // è®¾ç½®æµ‹è¯•æ—¶é—´
        document.getElementById('testTime').textContent = new Date().toLocaleString('zh-CN');

        let autoMessageDetected = false;
        let countdownValue = 10;
        let countdownInterval;

        // ç›‘æ§æ˜¯å¦æœ‰è‡ªåŠ¨æç¤ºæ¶ˆæ¯å‡ºç°
        function monitorAutoMessages() {
            // æ£€æŸ¥æ˜¯å¦æœ‰é€šçŸ¥å…ƒç´ å‡ºç°
            const notifications = document.querySelectorAll('.notification, .alert, [class*="message"], [class*="toast"]');
            const feedbackDivs = document.querySelectorAll('#contactFormFeedback, [id*="feedback"], [id*="message"]');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰åŒ…å«"è”ç³»è¡¨å•å·²å°±ç»ª"æˆ–ç±»ä¼¼æ–‡æœ¬çš„å…ƒç´ 
            const allElements = document.querySelectorAll('*');
            for (let element of allElements) {
                if (element.textContent && element.textContent.includes('è”ç³»è¡¨å•å·²å°±ç»ª')) {
                    autoMessageDetected = true;
                    break;
                }
                if (element.textContent && element.textContent.includes('å¯ä»¥æ­£å¸¸ä½¿ç”¨')) {
                    autoMessageDetected = true;
                    break;
                }
            }

            return autoMessageDetected;
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="status-item status-${type}">
                    <span>${message}</span>
                </div>
            `;
        }

        // å€’è®¡æ—¶ç›‘æ§
        function startCountdown() {
            const countdownElement = document.getElementById('countdown');
            
            countdownInterval = setInterval(() => {
                countdownValue--;
                if (countdownElement) {
                    countdownElement.textContent = countdownValue;
                }

                // æ£€æŸ¥è‡ªåŠ¨æ¶ˆæ¯
                if (monitorAutoMessages()) {
                    clearInterval(countdownInterval);
                    updateStatus('autoMessageStatus', 
                        'âŒ æ£€æµ‹åˆ°è‡ªåŠ¨æç¤ºæ¶ˆæ¯ï¼é¡µé¢ä»åœ¨æ˜¾ç¤ºä¸å¿…è¦çš„æç¤ºã€‚', 
                        'error');
                    updateVerificationResult();
                    return;
                }

                if (countdownValue <= 0) {
                    clearInterval(countdownInterval);
                    updateStatus('autoMessageStatus', 
                        'âœ… æœªæ£€æµ‹åˆ°è‡ªåŠ¨æç¤ºæ¶ˆæ¯ï¼ä¿®æ”¹æˆåŠŸã€‚', 
                        'success');
                    updateVerificationResult();
                }
            }, 1000);
        }

        // æµ‹è¯•è¡¨å•åŠŸèƒ½
        async function testFormFunction() {
            updateStatus('formFunctionStatus', 'ğŸ”„ æ­£åœ¨æµ‹è¯•è¡¨å•æäº¤åŠŸèƒ½...', 'info');

            try {
                // æ£€æŸ¥è¡¨å•æ˜¯å¦å­˜åœ¨
                const mainWindow = window.parent !== window ? window.parent : window;
                
                // å°è¯•è°ƒç”¨è¡¨å•æäº¤åŠŸèƒ½
                if (typeof window.showContactFormMessage === 'function') {
                    // æµ‹è¯•æˆåŠŸæ¶ˆæ¯æ˜¾ç¤º
                    window.showContactFormMessage('æµ‹è¯•ï¼šè¡¨å•åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼', 'success');
                    
                    setTimeout(() => {
                        updateStatus('formFunctionStatus', 
                            'âœ… è¡¨å•æç¤ºåŠŸèƒ½æ­£å¸¸ï¼å¯ä»¥æ˜¾ç¤ºæˆåŠŸ/å¤±è´¥æ¶ˆæ¯ã€‚', 
                            'success');
                        updateVerificationResult();
                    }, 1000);
                } else {
                    // å°è¯•APIæµ‹è¯•
                    const response = await fetch('/api/inquiries', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: 'åŠŸèƒ½æµ‹è¯•',
                            email: 'test@example.com',
                            message: 'è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½æµ‹è¯•æ¶ˆæ¯',
                            source: 'verification_test'
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        updateStatus('formFunctionStatus', 
                            'âœ… è¡¨å•æäº¤åŠŸèƒ½æ­£å¸¸ï¼APIå“åº”æˆåŠŸã€‚', 
                            'success');
                    } else {
                        updateStatus('formFunctionStatus', 
                            'âš ï¸ è¡¨å•APIå“åº”å¼‚å¸¸ï¼Œä½†è¿æ¥æ­£å¸¸ã€‚', 
                            'warning');
                    }
                    updateVerificationResult();
                }
            } catch (error) {
                updateStatus('formFunctionStatus', 
                    `âŒ è¡¨å•åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}`, 
                    'error');
                updateVerificationResult();
            }
        }

        // æ›´æ–°æœ€ç»ˆéªŒè¯ç»“æœ
        function updateVerificationResult() {
            const autoMessageOk = !autoMessageDetected;
            const formFunctionOk = document.getElementById('formFunctionStatus').innerHTML.includes('status-success');

            let resultMessage = '';
            let resultType = '';

            if (autoMessageOk && formFunctionOk) {
                resultMessage = 'ğŸ‰ éªŒè¯å®Œæˆï¼è‡ªåŠ¨æç¤ºå·²æˆåŠŸç§»é™¤ï¼Œè¡¨å•åŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚';
                resultType = 'success';
            } else if (autoMessageOk && !formFunctionOk) {
                resultMessage = 'âš ï¸ è‡ªåŠ¨æç¤ºå·²ç§»é™¤ï¼Œä½†è¡¨å•åŠŸèƒ½éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥ã€‚';
                resultType = 'warning';
            } else if (!autoMessageOk) {
                resultMessage = 'âŒ ä»ç„¶æ£€æµ‹åˆ°è‡ªåŠ¨æç¤ºæ¶ˆæ¯ï¼Œéœ€è¦è¿›ä¸€æ­¥ä¿®å¤ã€‚';
                resultType = 'error';
            } else {
                resultMessage = 'ğŸ”„ éªŒè¯è¿›è¡Œä¸­...';
                resultType = 'info';
            }

            updateStatus('verificationResult', resultMessage, resultType);
        }

        // é¡µé¢åŠ è½½æ—¶å¼€å§‹ç›‘æ§
        window.addEventListener('load', () => {
            console.log('ğŸ” å¼€å§‹ç›‘æ§è‡ªåŠ¨æç¤ºæ¶ˆæ¯...');
            startCountdown();
            
            // åˆå§‹æ£€æŸ¥
            setTimeout(() => {
                if (monitorAutoMessages()) {
                    clearInterval(countdownInterval);
                    updateStatus('autoMessageStatus', 
                        'âŒ é¡µé¢åŠ è½½æ—¶æ£€æµ‹åˆ°è‡ªåŠ¨æç¤ºæ¶ˆæ¯ï¼', 
                        'error');
                    updateVerificationResult();
                }
            }, 2000);
        });

        // ç›‘å¬DOMå˜åŒ–
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            if (node.textContent && 
                                (node.textContent.includes('è”ç³»è¡¨å•å·²å°±ç»ª') || 
                                 node.textContent.includes('å¯ä»¥æ­£å¸¸ä½¿ç”¨'))) {
                                autoMessageDetected = true;
                                clearInterval(countdownInterval);
                                updateStatus('autoMessageStatus', 
                                    'âŒ æ£€æµ‹åˆ°è‡ªåŠ¨æç¤ºæ¶ˆæ¯å‡ºç°ï¼', 
                                    'error');
                                updateVerificationResult();
                            }
                        }
                    });
                }
            });
        });

        // å¼€å§‹è§‚å¯ŸDOMå˜åŒ–
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    </script>
</body>
</html>
