#!/bin/bash
# ===================================
# Gitè‡ªåŠ¨åŒ–è§£å†³æ–¹æ¡ˆ - Commit-msgé’©å­
# è§„èŒƒå’ŒéªŒè¯æäº¤ä¿¡æ¯æ ¼å¼
# ===================================

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ—¥å¿—æ–‡ä»¶
LOG_FILE=".commit-msg.log"

# æäº¤ä¿¡æ¯æ–‡ä»¶
COMMIT_MSG_FILE="$1"

# è®°å½•æ—¥å¿—å‡½æ•°
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# æ‰“å°å¸¦é¢œè‰²çš„æ¶ˆæ¯
print_message() {
    local color=$1
    local message=$2
    echo -e "${color}$message${NC}"
    log "$message"
}

print_message $BLUE "ğŸ“ å¼€å§‹éªŒè¯æäº¤ä¿¡æ¯..."

# è¯»å–æäº¤ä¿¡æ¯
commit_msg=$(cat "$COMMIT_MSG_FILE")

# ç§»é™¤æ³¨é‡Šè¡Œå’Œç©ºè¡Œ
clean_msg=$(echo "$commit_msg" | grep -v '^#' | grep -v '^$' | head -1)

print_message $BLUE "åŸå§‹æäº¤ä¿¡æ¯: $clean_msg"

# 1. æ£€æŸ¥æäº¤ä¿¡æ¯æ˜¯å¦ä¸ºç©º
if [ -z "$clean_msg" ]; then
    print_message $RED "âŒ æäº¤ä¿¡æ¯ä¸èƒ½ä¸ºç©º"
    print_message $YELLOW "ğŸ’¡ æç¤º: è¯·æä¾›æœ‰æ„ä¹‰çš„æäº¤ä¿¡æ¯"
    exit 1
fi

# 2. æ£€æŸ¥æäº¤ä¿¡æ¯é•¿åº¦
msg_length=${#clean_msg}
if [ $msg_length -lt 10 ]; then
    print_message $RED "âŒ æäº¤ä¿¡æ¯è¿‡çŸ­ (å½“å‰: $msg_length å­—ç¬¦ï¼Œæœ€å°‘: 10 å­—ç¬¦)"
    print_message $YELLOW "ğŸ’¡ æç¤º: è¯·æä¾›æ›´è¯¦ç»†çš„æäº¤ä¿¡æ¯"
    exit 1
fi

if [ $msg_length -gt 72 ]; then
    print_message $YELLOW "âš ï¸  æäº¤ä¿¡æ¯è¾ƒé•¿ (å½“å‰: $msg_length å­—ç¬¦ï¼Œå»ºè®®: â‰¤72 å­—ç¬¦)"
    print_message $YELLOW "ğŸ’¡ å»ºè®®: å°†è¯¦ç»†è¯´æ˜æ”¾åœ¨æäº¤ä¿¡æ¯çš„ç¬¬äºŒæ®µ"
fi

# 3. æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼ (Conventional Commits)
valid_types=("feat" "fix" "docs" "style" "refactor" "test" "chore" "perf" "ci" "build" "revert")
type_pattern="^($(IFS="|"; echo "${valid_types[*]}"))"

if echo "$clean_msg" | grep -qE "$type_pattern"; then
    # æå–æäº¤ç±»å‹
    commit_type=$(echo "$clean_msg" | sed -E 's/^([a-z]+)(\([^)]+\))?: .*/\1/')
    print_message $GREEN "âœ… æ£€æµ‹åˆ°è§„èŒƒçš„æäº¤ç±»å‹: $commit_type"
    
    # æ£€æŸ¥æ ¼å¼æ˜¯å¦å®Œæ•´
    if ! echo "$clean_msg" | grep -qE "^[a-z]+(\([^)]+\))?: .+"; then
        print_message $RED "âŒ æäº¤ä¿¡æ¯æ ¼å¼ä¸æ­£ç¡®"
        print_message $YELLOW "ğŸ’¡ æ­£ç¡®æ ¼å¼: type(scope): description"
        print_message $YELLOW "   ä¾‹å¦‚: feat(auth): æ·»åŠ ç”¨æˆ·ç™»å½•åŠŸèƒ½"
        exit 1
    fi
else
    print_message $YELLOW "âš ï¸  æœªä½¿ç”¨è§„èŒƒçš„æäº¤ç±»å‹"
    print_message $BLUE "ğŸ“‹ å»ºè®®ä½¿ç”¨ä»¥ä¸‹ç±»å‹ä¹‹ä¸€:"
    for type in "${valid_types[@]}"; do
        case $type in
            "feat")     echo "   - feat:     æ–°åŠŸèƒ½" ;;
            "fix")      echo "   - fix:      ä¿®å¤bug" ;;
            "docs")     echo "   - docs:     æ–‡æ¡£æ›´æ–°" ;;
            "style")    echo "   - style:    ä»£ç æ ¼å¼åŒ–" ;;
            "refactor") echo "   - refactor: é‡æ„ä»£ç " ;;
            "test")     echo "   - test:     æ·»åŠ æˆ–ä¿®æ”¹æµ‹è¯•" ;;
            "chore")    echo "   - chore:    æ„å»ºè¿‡ç¨‹æˆ–è¾…åŠ©å·¥å…·çš„å˜åŠ¨" ;;
            "perf")     echo "   - perf:     æ€§èƒ½ä¼˜åŒ–" ;;
            "ci")       echo "   - ci:       CI/CDé…ç½®" ;;
            "build")    echo "   - build:    æ„å»ºç³»ç»Ÿ" ;;
            "revert")   echo "   - revert:   å›æ»šæäº¤" ;;
        esac
    done
    
    # è¯¢é—®æ˜¯å¦è¦è‡ªåŠ¨æ ¼å¼åŒ–
    if [ -t 0 ]; then  # æ£€æŸ¥æ˜¯å¦åœ¨äº¤äº’å¼ç»ˆç«¯ä¸­
        read -p "æ˜¯å¦è¦è‡ªåŠ¨æ ¼å¼åŒ–æäº¤ä¿¡æ¯? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            print_message $BLUE "ğŸ”§ è‡ªåŠ¨æ ¼å¼åŒ–æäº¤ä¿¡æ¯..."
            
            # å°è¯•æ™ºèƒ½è¯†åˆ«æäº¤ç±»å‹
            auto_type="chore"
            if echo "$clean_msg" | grep -iE "(add|æ–°å¢|æ·»åŠ |create|åˆ›å»º)" >/dev/null; then
                auto_type="feat"
            elif echo "$clean_msg" | grep -iE "(fix|ä¿®å¤|è§£å†³|bug)" >/dev/null; then
                auto_type="fix"
            elif echo "$clean_msg" | grep -iE "(doc|æ–‡æ¡£|readme)" >/dev/null; then
                auto_type="docs"
            elif echo "$clean_msg" | grep -iE "(test|æµ‹è¯•)" >/dev/null; then
                auto_type="test"
            elif echo "$clean_msg" | grep -iE "(refactor|é‡æ„|ä¼˜åŒ–)" >/dev/null; then
                auto_type="refactor"
            fi
            
            # æ ¼å¼åŒ–æäº¤ä¿¡æ¯
            formatted_msg="$auto_type: $clean_msg"
            echo "$formatted_msg" > "$COMMIT_MSG_FILE"
            
            print_message $GREEN "âœ… å·²æ ¼å¼åŒ–ä¸º: $formatted_msg"
        fi
    fi
fi

# 4. æ£€æŸ¥ç¦ç”¨è¯æ±‡
forbidden_words=("fuck" "shit" "damn" "stupid" "idiot" "wtf" "ä¸´æ—¶" "æµ‹è¯•æäº¤" "éšä¾¿æäº¤")
for word in "${forbidden_words[@]}"; do
    if echo "$clean_msg" | grep -iE "$word" >/dev/null; then
        print_message $RED "âŒ æäº¤ä¿¡æ¯åŒ…å«ä¸å½“è¯æ±‡: $word"
        print_message $YELLOW "ğŸ’¡ è¯·ä½¿ç”¨ä¸“ä¸šçš„æäº¤ä¿¡æ¯"
        exit 1
    fi
done

# 5. æ£€æŸ¥æ˜¯å¦åŒ…å«issueæˆ–ticketå¼•ç”¨
if echo "$clean_msg" | grep -E "#[0-9]+" >/dev/null; then
    issue_ref=$(echo "$clean_msg" | grep -oE "#[0-9]+" | head -1)
    print_message $GREEN "âœ… æ£€æµ‹åˆ°issueå¼•ç”¨: $issue_ref"
elif echo "$clean_msg" | grep -iE "(close|closes|fix|fixes|resolve|resolves)" >/dev/null; then
    print_message $YELLOW "âš ï¸  æ£€æµ‹åˆ°å…³é—­å…³é”®è¯ä½†æœªæ‰¾åˆ°issueå¼•ç”¨"
    print_message $YELLOW "ğŸ’¡ å»ºè®®æ·»åŠ issueå¼•ç”¨ï¼Œå¦‚: closes #123"
fi

# 6. æ£€æŸ¥æäº¤ä¿¡æ¯è¯­è¨€
if echo "$clean_msg" | grep -E "[\u4e00-\u9fa5]" >/dev/null; then
    print_message $BLUE "ğŸŒ æ£€æµ‹åˆ°ä¸­æ–‡æäº¤ä¿¡æ¯"
elif echo "$clean_msg" | grep -E "[a-zA-Z]" >/dev/null; then
    print_message $BLUE "ğŸŒ æ£€æµ‹åˆ°è‹±æ–‡æäº¤ä¿¡æ¯"
fi

# 7. ç”Ÿæˆæäº¤ç»Ÿè®¡
current_branch=$(git rev-parse --abbrev-ref HEAD)
commit_count=$(git rev-list --count HEAD 2>/dev/null || echo "1")

print_message $BLUE "ğŸ“Š æäº¤ç»Ÿè®¡ä¿¡æ¯:"
echo "   - å½“å‰åˆ†æ”¯: $current_branch"
echo "   - æäº¤åºå·: #$commit_count"
echo "   - ä¿¡æ¯é•¿åº¦: $msg_length å­—ç¬¦"
echo "   - éªŒè¯æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"

# 8. ä¿å­˜æäº¤å†å²
commit_history_file=".git-commit-history.log"
{
    echo "$(date '+%Y-%m-%d %H:%M:%S') | $current_branch | $clean_msg"
} >> "$commit_history_file"

# 9. æ£€æŸ¥è¿ç»­ç›¸ä¼¼æäº¤
if [ -f "$commit_history_file" ]; then
    recent_commits=$(tail -5 "$commit_history_file" | cut -d'|' -f3 | tr -d ' ')
    current_msg_clean=$(echo "$clean_msg" | tr -d ' ')
    
    similar_count=0
    while IFS= read -r line; do
        if [ "$line" = "$current_msg_clean" ]; then
            similar_count=$((similar_count + 1))
        fi
    done <<< "$recent_commits"
    
    if [ $similar_count -gt 1 ]; then
        print_message $YELLOW "âš ï¸  æ£€æµ‹åˆ°ç›¸ä¼¼çš„æäº¤ä¿¡æ¯ (æœ€è¿‘5æ¬¡ä¸­æœ‰ $similar_count æ¬¡)"
        print_message $YELLOW "ğŸ’¡ å»ºè®®ä½¿ç”¨æ›´å…·ä½“çš„æè¿°"
    fi
fi

# 10. æ·»åŠ è‡ªåŠ¨åŒ–æ ‡ç­¾
if [ "$current_branch" != "main" ] && [ "$current_branch" != "master" ]; then
    # ä¸ºéä¸»åˆ†æ”¯æ·»åŠ åˆ†æ”¯æ ‡è¯†
    if ! echo "$clean_msg" | grep -E "\[$current_branch\]" >/dev/null; then
        enhanced_msg="[$current_branch] $clean_msg"
        
        # è¯¢é—®æ˜¯å¦æ·»åŠ åˆ†æ”¯æ ‡è¯†
        if [ -t 0 ]; then
            read -p "æ˜¯å¦æ·»åŠ åˆ†æ”¯æ ‡è¯†? (y/N): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                echo "$enhanced_msg" > "$COMMIT_MSG_FILE"
                print_message $GREEN "âœ… å·²æ·»åŠ åˆ†æ”¯æ ‡è¯†: [$current_branch]"
            fi
        fi
    fi
fi

print_message $GREEN "ğŸ‰ æäº¤ä¿¡æ¯éªŒè¯é€šè¿‡ï¼"
print_message $BLUE "ğŸ“ æœ€ç»ˆæäº¤ä¿¡æ¯: $(cat "$COMMIT_MSG_FILE" | grep -v '^#' | grep -v '^$' | head -1)"

exit 0
