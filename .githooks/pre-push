#!/bin/bash
# ===================================
# Gitè‡ªåŠ¨åŒ–è§£å†³æ–¹æ¡ˆ - Pre-pushé’©å­
# åœ¨æ¨é€å‰æ‰§è¡Œæœ€ç»ˆéªŒè¯å’Œå®‰å…¨æ£€æŸ¥
# ===================================

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ—¥å¿—æ–‡ä»¶
LOG_FILE=".pre-push.log"

# è®°å½•æ—¥å¿—å‡½æ•°
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# æ‰“å°å¸¦é¢œè‰²çš„æ¶ˆæ¯
print_message() {
    local color=$1
    local message=$2
    echo -e "${color}$message${NC}"
    log "$message"
}

# è·å–æ¨é€ä¿¡æ¯
remote="$1"
url="$2"

print_message $BLUE "ğŸš€ å¼€å§‹æ‰§è¡Œ Pre-push æ£€æŸ¥..."
print_message $BLUE "ğŸ“¡ æ¨é€ç›®æ ‡: $remote ($url)"

# è¯»å–æ ‡å‡†è¾“å…¥è·å–æ¨é€çš„å¼•ç”¨ä¿¡æ¯
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        # åˆ é™¤åˆ†æ”¯
        print_message $YELLOW "ğŸ—‘ï¸  åˆ é™¤åˆ†æ”¯: $remote_ref"
        continue
    fi
    
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # æ–°åˆ†æ”¯
        print_message $BLUE "ğŸŒŸ æ–°åˆ†æ”¯: $local_ref -> $remote_ref"
        range="$local_sha"
    else
        # æ›´æ–°ç°æœ‰åˆ†æ”¯
        print_message $BLUE "ğŸ”„ æ›´æ–°åˆ†æ”¯: $local_ref -> $remote_ref"
        range="$remote_sha..$local_sha"
    fi
    
    # 1. æ£€æŸ¥æäº¤å†å²
    print_message $BLUE "ğŸ“š æ£€æŸ¥æäº¤å†å²..."
    
    commit_count=$(git rev-list --count $range 2>/dev/null || echo "0")
    print_message $BLUE "   æ¨é€æäº¤æ•°: $commit_count"
    
    if [ "$commit_count" -gt 20 ]; then
        print_message $YELLOW "âš ï¸  æ¨é€çš„æäº¤æ•°é‡è¾ƒå¤š ($commit_count)ï¼Œè¯·ç¡®è®¤æ˜¯å¦æ­£ç¡®"
        read -p "æ˜¯å¦ç»§ç»­æ¨é€? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_message $RED "âŒ ç”¨æˆ·å–æ¶ˆæ¨é€"
            exit 1
        fi
    fi
    
    # 2. æ£€æŸ¥æäº¤ä¿¡æ¯è´¨é‡
    print_message $BLUE "ğŸ“ æ£€æŸ¥æäº¤ä¿¡æ¯è´¨é‡..."
    
    bad_commits=()
    while IFS= read -r commit; do
        if [ -n "$commit" ]; then
            commit_msg=$(git log --format=%s -n 1 "$commit")
            
            # æ£€æŸ¥æäº¤ä¿¡æ¯é•¿åº¦
            if [ ${#commit_msg} -lt 10 ]; then
                bad_commits+=("$commit: æäº¤ä¿¡æ¯è¿‡çŸ­")
            elif [ ${#commit_msg} -gt 72 ]; then
                bad_commits+=("$commit: æäº¤ä¿¡æ¯è¿‡é•¿")
            fi
            
            # æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸´æ—¶æäº¤ä¿¡æ¯
            if echo "$commit_msg" | grep -iE "(wip|todo|fixme|temp|test)" >/dev/null; then
                bad_commits+=("$commit: åŒ…å«ä¸´æ—¶æäº¤ä¿¡æ¯")
            fi
        fi
    done < <(git rev-list $range 2>/dev/null || true)
    
    if [ ${#bad_commits[@]} -gt 0 ]; then
        print_message $YELLOW "âš ï¸  å‘ç°æäº¤ä¿¡æ¯é—®é¢˜:"
        for bad_commit in "${bad_commits[@]}"; do
            echo "   - $bad_commit"
        done
        
        read -p "æ˜¯å¦ç»§ç»­æ¨é€? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_message $RED "âŒ ç”¨æˆ·å–æ¶ˆæ¨é€"
            exit 1
        fi
    fi
    
    # 3. è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
    if [ -f "package.json" ] && grep -q '"test"' package.json; then
        print_message $BLUE "ğŸ§ª è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶..."
        
        if npm test; then
            print_message $GREEN "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡"
        else
            print_message $RED "âŒ æµ‹è¯•å¤±è´¥"
            print_message $RED "è¯·ä¿®å¤æµ‹è¯•é—®é¢˜åé‡æ–°æ¨é€"
            exit 1
        fi
    fi
    
    # 4. æ£€æŸ¥ä¾èµ–å®‰å…¨æ€§
    if command -v npm >/dev/null 2>&1; then
        print_message $BLUE "ğŸ”’ æ£€æŸ¥ä¾èµ–å®‰å…¨æ€§..."
        
        if npm audit --audit-level=high 2>/dev/null; then
            print_message $GREEN "âœ… ä¾èµ–å®‰å…¨æ£€æŸ¥é€šè¿‡"
        else
            print_message $YELLOW "âš ï¸  å‘ç°å®‰å…¨æ¼æ´ï¼Œå»ºè®®è¿è¡Œ 'npm audit fix'"
            
            read -p "æ˜¯å¦ç»§ç»­æ¨é€? (y/N): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                print_message $RED "âŒ ç”¨æˆ·å–æ¶ˆæ¨é€"
                exit 1
            fi
        fi
    fi
    
    # 5. æ£€æŸ¥åˆ†æ”¯ä¿æŠ¤
    current_branch=$(git rev-parse --abbrev-ref HEAD)
    protected_branches=("main" "master" "production" "release")
    
    for protected in "${protected_branches[@]}"; do
        if [ "$current_branch" = "$protected" ]; then
            print_message $YELLOW "âš ï¸  æ­£åœ¨æ¨é€åˆ°ä¿æŠ¤åˆ†æ”¯: $protected"
            
            read -p "ç¡®è®¤æ¨é€åˆ°ä¿æŠ¤åˆ†æ”¯? (y/N): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                print_message $RED "âŒ ç”¨æˆ·å–æ¶ˆæ¨é€åˆ°ä¿æŠ¤åˆ†æ”¯"
                exit 1
            fi
            break
        fi
    done
    
    # 6. æ£€æŸ¥æ–‡ä»¶å˜æ›´è§„æ¨¡
    print_message $BLUE "ğŸ“Š åˆ†ææ–‡ä»¶å˜æ›´..."
    
    files_changed=$(git diff --name-only $range 2>/dev/null | wc -l || echo "0")
    lines_added=$(git diff --shortstat $range 2>/dev/null | grep -o '[0-9]\+ insertion' | grep -o '[0-9]\+' || echo "0")
    lines_deleted=$(git diff --shortstat $range 2>/dev/null | grep -o '[0-9]\+ deletion' | grep -o '[0-9]\+' || echo "0")
    
    print_message $BLUE "   æ–‡ä»¶å˜æ›´: $files_changed ä¸ª"
    print_message $BLUE "   æ–°å¢è¡Œæ•°: $lines_added"
    print_message $BLUE "   åˆ é™¤è¡Œæ•°: $lines_deleted"
    
    if [ "$files_changed" -gt 50 ] || [ "$lines_added" -gt 1000 ]; then
        print_message $YELLOW "âš ï¸  å˜æ›´è§„æ¨¡è¾ƒå¤§ï¼Œè¯·ç¡®è®¤æ˜¯å¦æ­£ç¡®"
        
        read -p "æ˜¯å¦ç»§ç»­æ¨é€? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_message $RED "âŒ ç”¨æˆ·å–æ¶ˆæ¨é€"
            exit 1
        fi
    fi
    
    # 7. åˆ›å»ºæ¨é€å¤‡ä»½
    print_message $BLUE "ğŸ’¾ åˆ›å»ºæ¨é€å¤‡ä»½..."
    
    backup_dir=".git-backup"
    mkdir -p "$backup_dir"
    
    backup_file="$backup_dir/push-backup-$(date +%Y%m%d-%H%M%S).txt"
    {
        echo "æ¨é€æ—¶é—´: $(date)"
        echo "åˆ†æ”¯: $local_ref -> $remote_ref"
        echo "æäº¤èŒƒå›´: $range"
        echo "æäº¤æ•°é‡: $commit_count"
        echo "æ–‡ä»¶å˜æ›´: $files_changed"
        echo "æ–°å¢è¡Œæ•°: $lines_added"
        echo "åˆ é™¤è¡Œæ•°: $lines_deleted"
        echo ""
        echo "æäº¤åˆ—è¡¨:"
        git log --oneline $range 2>/dev/null || true
    } > "$backup_file"
    
    print_message $GREEN "âœ… å¤‡ä»½å·²ä¿å­˜: $backup_file"
    
    # 8. æœ€ç»ˆç¡®è®¤
    if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
        print_message $YELLOW "ğŸš¨ æœ€ç»ˆç¡®è®¤: å³å°†æ¨é€åˆ°ä¸»åˆ†æ”¯"
        print_message $BLUE "   åˆ†æ”¯: $current_branch"
        print_message $BLUE "   æäº¤: $commit_count ä¸ª"
        print_message $BLUE "   æ–‡ä»¶: $files_changed ä¸ª"
        
        read -p "æœ€ç»ˆç¡®è®¤æ¨é€? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_message $RED "âŒ ç”¨æˆ·å–æ¶ˆæ¨é€"
            exit 1
        fi
    fi
    
done

print_message $GREEN "ğŸ‰ Pre-push æ£€æŸ¥å…¨éƒ¨é€šè¿‡ï¼"
print_message $BLUE "ğŸ“¡ å‡†å¤‡æ¨é€åˆ°: $remote"
print_message $BLUE "ğŸ• æ¨é€æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"

exit 0
