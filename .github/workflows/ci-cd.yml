# ===================================
# Gitè‡ªåŠ¨åŒ–è§£å†³æ–¹æ¡ˆ - CI/CDæµæ°´çº¿
# GitHub Actionsé…ç½®æ–‡ä»¶
# ===================================

name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [main, develop, "feature/*", "hotfix/*"]
  pull_request:
    branches: [main, develop]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå®‰å…¨æ‰«æ
    - cron: "0 2 * * *"

env:
  NODE_VERSION: "18"
  TIMEZONE: "Asia/Shanghai"

jobs:
  # ===================================
  # ä»£ç è´¨é‡æ£€æŸ¥
  # ===================================
  code-quality:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ç”¨äºåˆ†æ

      - name: ğŸ—ï¸ è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          npm ci
          npm install -g eslint prettier jshint

      - name: ğŸ” ESLintä»£ç æ£€æŸ¥
        run: |
          echo "ğŸ” è¿è¡ŒESLintæ£€æŸ¥..."
          npx eslint . --ext .js,.jsx,.ts,.tsx --format=json --output-file=eslint-report.json || true
          npx eslint . --ext .js,.jsx,.ts,.tsx || echo "ESLintå‘ç°é—®é¢˜ï¼Œä½†ç»§ç»­æ‰§è¡Œ"

      - name: ğŸ¨ Prettieræ ¼å¼æ£€æŸ¥
        run: |
          echo "ğŸ¨ æ£€æŸ¥ä»£ç æ ¼å¼..."
          npx prettier --check "**/*.{js,jsx,ts,tsx,json,css,md}" || echo "æ ¼å¼æ£€æŸ¥å‘ç°é—®é¢˜"

      - name: ğŸ“Š ä»£ç å¤æ‚åº¦åˆ†æ
        run: |
          echo "ğŸ“Š åˆ†æä»£ç å¤æ‚åº¦..."
          npm install -g complexity-report
          cr --format json --output complexity-report.json . || true

      - name: ğŸ“ˆ ä¸Šä¼ ä»£ç è´¨é‡æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-quality-reports
          path: |
            eslint-report.json
            complexity-report.json
          retention-days: 30

  # ===================================
  # å®‰å…¨æ‰«æ
  # ===================================
  security-scan:
    name: ğŸ”’ å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ”’ npm auditå®‰å…¨æ£€æŸ¥
        run: |
          echo "ğŸ”’ è¿è¡Œnpm audit..."
          npm audit --audit-level=moderate --json > npm-audit.json || true
          npm audit --audit-level=moderate || echo "å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯·æ£€æŸ¥"

      - name: ğŸ” æ•æ„Ÿä¿¡æ¯æ‰«æ
        run: |
          echo "ğŸ” æ‰«ææ•æ„Ÿä¿¡æ¯..."
          # æ£€æŸ¥å¸¸è§çš„æ•æ„Ÿä¿¡æ¯æ¨¡å¼
          grep -r -i "password\|api_key\|secret\|token" --include="*.js" --include="*.json" . || echo "æœªå‘ç°æ˜æ˜¾çš„æ•æ„Ÿä¿¡æ¯"

          # æ£€æŸ¥ç¡¬ç¼–ç çš„URLå’ŒIP
          grep -r -E "http://|https://[^/]*\.(com|cn|org)" --include="*.js" . || echo "æœªå‘ç°ç¡¬ç¼–ç URL"

      - name: ğŸ“ˆ ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: npm-audit.json
          retention-days: 30

  # ===================================
  # å•å…ƒæµ‹è¯•
  # ===================================
  test:
    name: ğŸ§ª å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16, 18, 20]

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ è®¾ç½®Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ§ª è¿è¡Œæµ‹è¯•
        run: |
          echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
          # å¦‚æœæœ‰æµ‹è¯•è„šæœ¬å°±è¿è¡Œï¼Œå¦åˆ™åˆ›å»ºåŸºç¡€æµ‹è¯•
          if npm run test 2>/dev/null; then
            echo "âœ… æµ‹è¯•é€šè¿‡"
          else
            echo "âš ï¸ æ²¡æœ‰é…ç½®æµ‹è¯•ï¼Œåˆ›å»ºåŸºç¡€æµ‹è¯•..."
            mkdir -p test
            cat > test/basic.test.js << 'EOF'
          const assert = require('assert');

          describe('åŸºç¡€æµ‹è¯•', function() {
            it('åº”ç”¨å¯åŠ¨æµ‹è¯•', function() {
              assert.ok(true, 'åŸºç¡€æµ‹è¯•é€šè¿‡');
            });
            
            it('ç¯å¢ƒå˜é‡æµ‹è¯•', function() {
              process.env.NODE_ENV = 'test';
              assert.equal(process.env.NODE_ENV, 'test');
            });
          });
          EOF
            
            # å®‰è£…æµ‹è¯•æ¡†æ¶
            npm install --save-dev mocha
            npx mocha test/basic.test.js
          fi

      - name: ğŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡
        run: |
          echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š..."
          npm install --save-dev nyc
          npx nyc --reporter=html --reporter=text npm test || echo "è¦†ç›–ç‡ç”Ÿæˆå®Œæˆ"

      - name: ğŸ“ˆ ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-node-${{ matrix.node-version }}
          path: |
            coverage/
            test-results/
          retention-days: 30

  # ===================================
  # æ„å»ºæµ‹è¯•
  # ===================================
  build:
    name: ğŸ—ï¸ æ„å»ºæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [code-quality, test]

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ—ï¸ æ„å»ºåº”ç”¨
        run: |
          echo "ğŸ—ï¸ å¼€å§‹æ„å»ºåº”ç”¨..."

          # è®¾ç½®ç¯å¢ƒå˜é‡
          export NODE_ENV=production
          export TZ=${{ env.TIMEZONE }}

          # å¦‚æœæœ‰æ„å»ºè„šæœ¬å°±è¿è¡Œ
          if npm run build 2>/dev/null; then
            echo "âœ… æ„å»ºæˆåŠŸ"
          else
            echo "â„¹ï¸ æ²¡æœ‰é…ç½®æ„å»ºè„šæœ¬ï¼ŒéªŒè¯åº”ç”¨å¯åŠ¨..."
            timeout 10s npm start || echo "åº”ç”¨å¯åŠ¨æµ‹è¯•å®Œæˆ"
          fi

      - name: ğŸ“¦ åˆ›å»ºéƒ¨ç½²åŒ…
        run: |
          echo "ğŸ“¦ åˆ›å»ºéƒ¨ç½²åŒ…..."

          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          mkdir -p deploy

          # å¤åˆ¶å¿…è¦æ–‡ä»¶
          cp -r . deploy/
          cd deploy

          # æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶
          rm -rf .git .github node_modules/.cache
          rm -f .gitignore .env.example

          # é‡æ–°å®‰è£…ç”Ÿäº§ä¾èµ–
          npm ci --only=production

          # åˆ›å»ºå‹ç¼©åŒ…
          cd ..
          tar -czf diamond-website-${{ github.sha }}.tar.gz deploy/

          echo "âœ… éƒ¨ç½²åŒ…åˆ›å»ºå®Œæˆ"

      - name: ğŸ“ˆ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            diamond-website-${{ github.sha }}.tar.gz
            deploy/
          retention-days: 30

  # ===================================
  # éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  # ===================================
  deploy-staging:
    name: ğŸš€ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/develop'
    environment: staging

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: ğŸš€ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
          echo "ğŸ“¦ éƒ¨ç½²åŒ…: diamond-website-${{ github.sha }}.tar.gz"
          echo "ğŸŒ æµ‹è¯•ç¯å¢ƒURL: https://staging.example.com"
          echo "âœ… éƒ¨ç½²å®Œæˆï¼ˆæ¨¡æ‹Ÿï¼‰"

          # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„éƒ¨ç½²è„šæœ¬
          # ä¾‹å¦‚ï¼šscp, rsync, docker deployç­‰

      - name: ğŸ§ª éƒ¨ç½²åæµ‹è¯•
        run: |
          echo "ğŸ§ª è¿è¡Œéƒ¨ç½²åæµ‹è¯•..."

          # å¥åº·æ£€æŸ¥
          echo "â¤ï¸ å¥åº·æ£€æŸ¥..."
          # curl -f https://staging.example.com/health || exit 1

          # åŸºç¡€åŠŸèƒ½æµ‹è¯•
          echo "ğŸ” åŸºç¡€åŠŸèƒ½æµ‹è¯•..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ APIæµ‹è¯•ã€é¡µé¢æµ‹è¯•ç­‰

          echo "âœ… éƒ¨ç½²åæµ‹è¯•é€šè¿‡"

  # ===================================
  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  # ===================================
  deploy-production:
    name: ğŸŒŸ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: ğŸŒŸ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
        run: |
          echo "ğŸŒŸ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
          echo "ğŸ“¦ éƒ¨ç½²åŒ…: diamond-website-${{ github.sha }}.tar.gz"
          echo "ğŸŒ ç”Ÿäº§ç¯å¢ƒURL: https://www.example.com"

          # åˆ›å»ºéƒ¨ç½²å¤‡ä»½
          echo "ğŸ’¾ åˆ›å»ºéƒ¨ç½²å¤‡ä»½..."
          cp diamond-website-${{ github.sha }}.tar.gz production-backup-$(date +%Y%m%d-%H%M%S).tar.gz

          echo "âœ… ç”Ÿäº§éƒ¨ç½²å®Œæˆï¼ˆæ¨¡æ‹Ÿï¼‰"

          # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„ç”Ÿäº§éƒ¨ç½²è„šæœ¬

      - name: ğŸ§ª ç”Ÿäº§ç¯å¢ƒéªŒè¯
        run: |
          echo "ğŸ§ª ç”Ÿäº§ç¯å¢ƒéªŒè¯..."

          # å¥åº·æ£€æŸ¥
          echo "â¤ï¸ å¥åº·æ£€æŸ¥..."
          # curl -f https://www.example.com/health || exit 1

          # å…³é”®åŠŸèƒ½éªŒè¯
          echo "ğŸ” å…³é”®åŠŸèƒ½éªŒè¯..."

          echo "âœ… ç”Ÿäº§ç¯å¢ƒéªŒè¯é€šè¿‡"

      - name: ğŸ“¢ å‘é€éƒ¨ç½²é€šçŸ¥
        run: |
          echo "ğŸ“¢ å‘é€éƒ¨ç½²é€šçŸ¥..."
          echo "ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸ”— æäº¤: ${{ github.sha }}"
          echo "ğŸ‘¤ æ“ä½œè€…: ${{ github.actor }}"

          # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„é€šçŸ¥é€»è¾‘
          # ä¾‹å¦‚ï¼šSlack, é’‰é’‰, é‚®ä»¶ç­‰

  # ===================================
  # æ€§èƒ½æµ‹è¯•
  # ===================================
  performance-test:
    name: âš¡ æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[perf-test]')

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          npm ci
          npm install -g lighthouse autocannon

      - name: âš¡ æ€§èƒ½åŸºå‡†æµ‹è¯•
        run: |
          echo "âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•..."

          # å¯åŠ¨åº”ç”¨
          npm start &
          APP_PID=$!

          # ç­‰å¾…åº”ç”¨å¯åŠ¨
          sleep 10

          # è¿è¡Œæ€§èƒ½æµ‹è¯•
          echo "ğŸ” è¿è¡ŒLighthouseæµ‹è¯•..."
          # lighthouse http://localhost:3001 --output=json --output-path=lighthouse-report.json || true

          echo "ğŸš€ è¿è¡Œè´Ÿè½½æµ‹è¯•..."
          # autocannon -c 10 -d 30 http://localhost:3001 > load-test-report.txt || true

          # åœæ­¢åº”ç”¨
          kill $APP_PID || true

          echo "âœ… æ€§èƒ½æµ‹è¯•å®Œæˆ"

      - name: ğŸ“ˆ ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-reports
          path: |
            lighthouse-report.json
            load-test-report.txt
          retention-days: 30

  # ===================================
  # æ¸…ç†å’Œé€šçŸ¥
  # ===================================
  cleanup:
    name: ğŸ§¹ æ¸…ç†å’Œé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, test, build]
    if: always()

    steps:
      - name: ğŸ“Š æ”¶é›†æ‰§è¡Œç»“æœ
        run: |
          echo "ğŸ“Š CI/CDæ‰§è¡Œç»“æœæ±‡æ€»:"
          echo "ğŸ” ä»£ç è´¨é‡: ${{ needs.code-quality.result }}"
          echo "ğŸ”’ å®‰å…¨æ‰«æ: ${{ needs.security-scan.result }}"
          echo "ğŸ§ª å•å…ƒæµ‹è¯•: ${{ needs.test.result }}"
          echo "ğŸ—ï¸ æ„å»ºæµ‹è¯•: ${{ needs.build.result }}"

          # åˆ¤æ–­æ•´ä½“çŠ¶æ€
          if [[ "${{ needs.code-quality.result }}" == "success" && 
                "${{ needs.security-scan.result }}" == "success" && 
                "${{ needs.test.result }}" == "success" && 
                "${{ needs.build.result }}" == "success" ]]; then
            echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡"
            echo "OVERALL_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥"
            echo "OVERALL_STATUS=failure" >> $GITHUB_ENV
          fi

      - name: ğŸ“¢ å‘é€é€šçŸ¥
        if: always()
        run: |
          echo "ğŸ“¢ å‘é€CI/CDç»“æœé€šçŸ¥..."
          echo "ğŸ“… æ‰§è¡Œæ—¶é—´: $(date)"
          echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}"
          echo "ğŸ“ æäº¤: ${{ github.event.head_commit.message }}"
          echo "ğŸ‘¤ æäº¤è€…: ${{ github.actor }}"
          echo "ğŸ“Š çŠ¶æ€: ${{ env.OVERALL_STATUS }}"

          # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„é€šçŸ¥é€»è¾‘
